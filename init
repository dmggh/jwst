#! /bin/tcsh 

# =======================================================================
# Init server environment

if (( "$1" != "hst") && ("$1" != "jwst")) then
	echo 'usage: ./init [jwst|hst]'
	exit -1;
endif

set observatory=$1
shift

if (( "$1" != "dev") && ( "$1" != "vmdvlp") && "$1" != "prod") && ("$1" != "test")) then
	echo 'usage: ./init [jwst|hst] [dev|vmdvlp|prod|test]'
	exit -1;
endif

set mode=$1
shift

cd `dirname $0`
source env.csh

cd `dirname $0`/tools

if ($mode == "test" || $mode == "dev" || $mode =="vmdvlp") then
    echo -n "Test account password? "
    set password=$<
    echo "Adding test user"
    python adduser.py test jmiller@stsci.edu "$password"
endif

if ($observatory == "hst") then
    if ($mode == "prod") then
	python make_cdbs_links.py --copy
    else
	python make_cdbs_links.py
    endif
    python -m crds.list --hst --cached-mappings --full-path >hst_mappings
    python -m crds.list --hst --cached-references --full-path >hst_references
    # see command line options
    python add_files.py --hst --add-slow-fields --reinit-slow-fields --deliver @hst_mappings
    if ($mode == "prod") then
	python add_files.py --hst --add-slow-fields @hst_references
    else
	python add_files.py --hst @hst_references
	# Add just enough slow fields to pass unit tests
	python add_slow_fields.py u1r1346ri_bia.fits n9i1435li_crr.fits t3420177i_drk.fits w2r1956ri_idc.fits n9n16196i_a2d.fits t291659mi_ccd.fits u5d2012li_bpx.fits q911321oi_osc.fits wbj1825si_imp.fits v8816168i_pfl.fits w7j1705di_fls.fits ubi1853qi_mdz.fits
    endif
else if ($observatory == "jwst") then
	if (($mode == "dev") || ($mode == "vmdvlp")) then
		echo "Linking files from Central Store /grp/crds/jwst/..."
		mkdir -p ${CRDS_PATH}/mappings/jwst
		ln -s /grp/crds/jwst/mappings/jwst/* ${CRDS_PATH}/mappings/jwst
		mkdir -p ${CRDS_PATH}/references/jwst
		ln -s /grp/crds/jwst/references/jwst/* ${CRDS_PATH}/references/jwst
	endif
    python -m crds.list --jwst --cached-mappings --full-path >jwst_mappings
    python -m crds.list --jwst --cached-references --full-path >jwst_references
    python add_files.py --jwst --add-slow-fields --deliver @jwst_mappings
    python add_files.py --jwst --deliver @jwst_references
else
	echo "unknown observatory"
	exit -1;
endif
