#! /usr/bin/env pysh
#-*-python-*-

# Command to switch Apache ports to hide server during system backup restores.

usage("switch_port <project> <usecase> <old_port> <new_port> [-revert]", 4, 5)

revert = "-revert" in sys.argv
if revert:
   sys.argv.remove("-revert")

project = sys.argv[1]
usecase = sys.argv[2]
old_port = sys.argv[3]
new_port = sys.argv[4]

server = os.environ["CRDS_SERVER"]

assert project in ["hst","jwst"]
assert usecase in ["dev","test","ops"]
int(old_port)
int(new_port)

old_proxy_port = 80

if usecase == "ops":
   proxy = "{}-crds".format(project)
else:
   proxy = "{}-crds-{}".format(project, usecase)

sh("perl -pi -e's/${old_port}/${new_port}/g' servers/ssl.conf sources/configs/config.${usecase}.${project}.py", trace_commands=True) 

if revert:
   proxy, server  = server, proxy
   old_proxy_port, new_port = new_port, old_proxy_port

sh("perl -pi -e's/proxy_port = ${old_proxy_port}/proxy_port = ${new_port}/g' servers/ssl.conf sources/configs/config.${usecase}.${project}.py", trace_commands=True) 
sh("perl -pi -e's/PROXY = \"${proxy}\"/PROXY = \"${server}\"/g' sources/configs/config.${usecase}.${project}.py", trace_commands=True)

