

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CRDS Rules (Mappings) &mdash; CRDS 7.1.7 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/stsci.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="CRDS 7.1.7 documentation" href="index.html"/>
        <link rel="next" title="Library Use" href="library_use.html"/>
        <link rel="prev" title="Web Services" href="web_services.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
            <a href="index.html" class="icon icon-home"> CRDS
            
            <img src="_static/stsci_pri_combo_mark_white.png" class="logo" />
          </a>

          
            
            
              <div class="version">
                7.1
              </div>
            
          
          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
  
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_use.html">Best References Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_line_tools.html">Command Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="web_site_use.html">Using the CRDS Web Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="web_services.html">Web Services</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CRDS Rules (Mappings)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#naming">Naming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-structure">Basic Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#header">header</a></li>
<li class="toctree-l3"><a class="reference internal" href="#comment">comment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#selector">selector</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pipeline-mappings-pmap">Pipeline Mappings (.pmap)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instrument-mappings-imap">Instrument Mappings (.imap)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reference-mappings-rmap">Reference Mappings (.rmap)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#active-header-fields">Active Header Fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#required-parameters">Required Parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#parkey">parkey</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extra-keys">extra_keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reffile-switch">reffile_switch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#logical-header-expressions">Logical Header Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reffile-required">reffile_required</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rmap-relevance">rmap_relevance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parkey-relevance">parkey_relevance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hooks">hooks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#precondition-header">precondition_header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fallback-header">fallback_header</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#selectors">Selectors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#primitive-return-values">Primitive Return Values</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#single-filename">Single Filename</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filename-tuple">Filename Tuple</a></li>
<li class="toctree-l4"><a class="reference internal" href="#not-applicable">Not Applicable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#omit">Omit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#match">Match</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#parameter-tuples-and-simple-matches">Parameter Tuples and Simple Matches</a></li>
<li class="toctree-l4"><a class="reference internal" href="#single-parameter-values">Single Parameter Values</a></li>
<li class="toctree-l4"><a class="reference internal" href="#or">Or |</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wild-cards">Wild Cards *</a></li>
<li class="toctree-l4"><a class="reference internal" href="#regular-expressions">Regular Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#literal-expressions">Literal Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#relational-expressions">Relational Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#between">Between</a></li>
<li class="toctree-l4"><a class="reference internal" href="#n-a">N/A</a></li>
<li class="toctree-l4"><a class="reference internal" href="#not-expressions">NOT Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#substitution-parameters">Substitution Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-weighting">Match Weighting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#useafter">UseAfter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#selectversion">SelectVersion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#closesttime">ClosestTime</a></li>
<li class="toctree-l3"><a class="reference internal" href="#geometricallynearest">GeometricallyNearest</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bracket">Bracket</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="library_use.html">Library Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference_conventions.html">Reference File Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">CRDS Database Access</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">CRDS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>CRDS Rules (Mappings)</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/rmap_syntax.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="crds-rules-mappings">
<h1>CRDS Rules (Mappings)<a class="headerlink" href="#crds-rules-mappings" title="Permalink to this headline">¶</a></h1>
<p>CRDS mappings are organized in a 3 tier hierarchy:  pipeline (.pmap),
instrument (.imap), and reference (.rmap).   Based on dataset parameters,
the pipeline context is used to select an instrument mapping,  the instrument
mapping is used to select a reference mapping,  and finally the reference
mapping is used to select a reference file.</p>
<p>CRDS mappings are written in a subset of Python and given the proper global
definitions can be parsed directly by the Python interpreter.   Nothing
precludes writing a parser for CRDS mappings in some other language.</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/file_relationships.png"><img alt="diagram of file relationships, .pmap -&gt; .imap -&gt; .rmap -&gt; .reference" src="_images/file_relationships.png" style="width: 452.0px; height: 339.0px;" /></a>
</div>
<div class="section" id="naming">
<h2>Naming<a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h2>
<p>The CRDS HST mapping prototypes which are generated from information scraped from
the CDBS web site are named with the forms:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">observatory</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">pmap</span>                               <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">hst</span><span class="o">.</span><span class="n">pmap</span>
<span class="o">&lt;</span><span class="n">observatory</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">instrument</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">imap</span>                <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">hst_acs</span><span class="o">.</span><span class="n">imap</span>
<span class="o">&lt;</span><span class="n">observatory</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">instrument</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">filekind</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">rmap</span>   <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">hst_acs_darkfile</span><span class="o">.</span><span class="n">rmap</span>
</pre></div>
</div>
<p>The names of subsequent derived mappings include a version number:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">observatory</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">pmap</span>                               <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">hst_00001</span><span class="o">.</span><span class="n">pmap</span>
<span class="o">&lt;</span><span class="n">observatory</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">instrument</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">imap</span>                <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">hst_acs_00047</span><span class="o">.</span><span class="n">imap</span>
<span class="o">&lt;</span><span class="n">observatory</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">instrument</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">filekind</span><span class="o">&gt;</span> <span class="n">_</span> <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">rmap</span>   <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">hst_acs_darkfile_00012</span><span class="o">.</span><span class="n">rmap</span>
</pre></div>
</div>
</div>
<div class="section" id="basic-structure">
<h2>Basic Structure<a class="headerlink" href="#basic-structure" title="Permalink to this headline">¶</a></h2>
<p>All mappings have the same basic structure consisting of a “header” section followed by a “selector” section.</p>
<div class="section" id="header">
<h3>header<a class="headerlink" href="#header" title="Permalink to this headline">¶</a></h3>
<p>The header provides meta data describing the mapping.  A critical field in the mapping header is the “parkey”
field which names the dataset parameters (nominally FITS keywords or JWST data model names) which are used by
the selector to do a best references lookup.</p>
</div>
<div class="section" id="comment">
<h3>comment<a class="headerlink" href="#comment" title="Permalink to this headline">¶</a></h3>
<p>An optional multi-line comment block can be added between the header and selector sections.</p>
</div>
<div class="section" id="selector">
<h3>selector<a class="headerlink" href="#selector" title="Permalink to this headline">¶</a></h3>
<p>The selector provides matching rules used to look up the results of the mapping.  The selector is a nested tree
structure consisting of top-level selectors and sub-selectors.</p>
</div>
</div>
<div class="section" id="pipeline-mappings-pmap">
<h2>Pipeline Mappings (.pmap)<a class="headerlink" href="#pipeline-mappings-pmap" title="Permalink to this headline">¶</a></h2>
<p>A sample pipeline mapping for HST looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst.pmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;derived_from&#39;</span> <span class="p">:</span> <span class="s1">&#39;created by hand 12-23-2011&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mapping&#39;</span> <span class="p">:</span> <span class="s1">&#39;PIPELINE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;observatory&#39;</span> <span class="p">:</span> <span class="s1">&#39;HST&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">,),</span>
    <span class="s1">&#39;description&#39;</span> <span class="p">:</span> <span class="s1">&#39;Initially generated on 12-23-2011&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sha1sum&#39;</span> <span class="p">:</span> <span class="s1">&#39;e2c6392fd2731df1e8d933bd990f3fd313a813db&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;This is an optional mapping section used to add multiline commentary,</span>
<span class="s2">perhaps to describe mapping evolution or unusual behaviors.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">selector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ACS&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_acs.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;COS&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NICMOS&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_nicmos.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;STIS&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_stis.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WFC3&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_wfc3.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WFPC2&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_wfpc2.imap&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A pipeline mapping matches the dataset “INSTRUME” header keyword against its selector to look up an instrument
mapping file.</p>
</div>
<div class="section" id="instrument-mappings-imap">
<h2>Instrument Mappings (.imap)<a class="headerlink" href="#instrument-mappings-imap" title="Permalink to this headline">¶</a></h2>
<p>A sample instrument mapping for HST’s COS instrument looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;derived_from&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_0290.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;instrument&#39;</span> <span class="p">:</span> <span class="s1">&#39;COS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mapping&#39;</span> <span class="p">:</span> <span class="s1">&#39;INSTRUMENT&#39;</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_0291.imap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;observatory&#39;</span> <span class="p">:</span> <span class="s1">&#39;HST&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;REFTYPE&#39;</span><span class="p">,),</span>
    <span class="s1">&#39;sha1sum&#39;</span> <span class="p">:</span> <span class="s1">&#39;85184c1656b487e7af686a7ab75262dcefc882e8&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">selector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;badttab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_badttab_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bpixtab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_bpixtab_0254.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;brftab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_brftab_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;brsttab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_brsttab_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;deadtab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_deadtab_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dgeofile&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_dgeofile_0002.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;disptab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_disptab_0259.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flatfile&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_flatfile_0254.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fluxtab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_fluxtab_0261.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;geofile&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_geofile_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gsagtab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_gsagtab_0253.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hvtab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_hvtab_0259.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lamptab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_lamptab_0251.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;phatab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_phatab_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;proftab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_proftab_0265.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;spottab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_spottab_0004.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;spwcstab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_spwcstab_0251.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tdstab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_tdstab_0254.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tracetab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_tracetab_0265.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;twozxtab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_twozxtab_0266.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wcptab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_wcptab_0255.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;xtractab&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_xtractab_0257.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;xwlkfile&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_xwlkfile_0002.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ywlkfile&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_ywlkfile_0002.rmap&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Instrument mappings match the desired reference file type against the reference mapping used to determine a
best reference recommendation for a particular dataset.  An instrument mapping lists all possible reference types for
all modes of the instrument,  some of which may not be appropriate for a particular mode.</p>
<p>For HST, the header keywords FILETYPE or CDBSFILE are used to define a reference’s type and corresponding rmap.
FILETYPE is in turn translated to the keyword names used to record reference files in datasets
(CRDS names these “filekind”),  and these appear directly in rmap names, e.g. FILETYPE=BIAS translates to BIASFILE which
appears in the rmap hst_acs_biasfile_0250.rmap.  NOTE: the HST .imap’s incorrectly specify REFTYPE in the .imap’s
but the value is unused.</p>
<p>For JWST, the header keyword REFTYPE (META.REFTYPE) is used to select the rmap.   For JWST, the REFTYPE
appears directly in file names, e.g. REFTYPE=SUPERBIAS is part of the rmap name jwst_nirspec_superbias_0001.rmap.</p>
</div>
<div class="section" id="reference-mappings-rmap">
<h2>Reference Mappings (.rmap)<a class="headerlink" href="#reference-mappings-rmap" title="Permalink to this headline">¶</a></h2>
<p>A sample reference mapping for HST COS DEADTAB looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;derived_from&#39;</span> <span class="p">:</span> <span class="s1">&#39;generated from CDBS database 2014-05-09 23:24:57.840119&#39;</span><span class="p">,</span>
    <span class="s1">&#39;filekind&#39;</span> <span class="p">:</span> <span class="s1">&#39;DEADTAB&#39;</span><span class="p">,</span>
    <span class="s1">&#39;instrument&#39;</span> <span class="p">:</span> <span class="s1">&#39;COS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mapping&#39;</span> <span class="p">:</span> <span class="s1">&#39;REFERENCE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;hst_cos_deadtab_0250.rmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;observatory&#39;</span> <span class="p">:</span> <span class="s1">&#39;HST&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">((</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="s1">&#39;TIME-OBS&#39;</span><span class="p">)),</span>
    <span class="s1">&#39;reffile_format&#39;</span> <span class="p">:</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reffile_required&#39;</span> <span class="p">:</span> <span class="s1">&#39;NONE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reffile_switch&#39;</span> <span class="p">:</span> <span class="s1">&#39;DEADCORR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rmap_relevance&#39;</span> <span class="p">:</span> <span class="s1">&#39;(DEADCORR != &quot;OMIT&quot;)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sha1sum&#39;</span> <span class="p">:</span> <span class="s1">&#39;bde314f1848b67891d6309b30eaa5c95611f86e2&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">Match</span><span class="p">({</span>
    <span class="p">(</span><span class="s1">&#39;FUV&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
        <span class="s1">&#39;1996-10-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s1">&#39;s7g1700gl_dead.fits&#39;</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s1">&#39;NUV&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
        <span class="s1">&#39;1996-10-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s1">&#39;s7g1700ql_dead.fits&#39;</span><span class="p">,</span>
    <span class="p">}),</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Reference mapping selectors are constructed as a nested hierarchy of selection operators which match against
various dataset header keywords.</p>
</div>
<div class="section" id="active-header-fields">
<h2>Active Header Fields<a class="headerlink" href="#active-header-fields" title="Permalink to this headline">¶</a></h2>
<p>Many rmap header fields are passive metadata.   A number of optional rmap header fields,  however,  actively affect
best reference lookups and results:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
          <span class="o">...</span><span class="p">,</span>

    <span class="s1">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">((</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="s1">&#39;TIME-OBS&#39;</span><span class="p">)),</span>

    <span class="s1">&#39;extra_keys&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;XCORNER&#39;</span><span class="p">,</span> <span class="s1">&#39;YCORNER&#39;</span><span class="p">,</span> <span class="s1">&#39;CCDCHIP&#39;</span><span class="p">),</span>

    <span class="s1">&#39;reffile_switch&#39;</span> <span class="p">:</span> <span class="s1">&#39;BIASCORR&#39;</span><span class="p">,</span>

    <span class="s1">&#39;reffile_required&#39;</span> <span class="p">:</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span>

    <span class="s1">&#39;rmap_relevance&#39;</span> <span class="p">:</span> <span class="s1">&#39;((DETECTOR != &quot;SBC&quot;) and (BIASCORR != &quot;OMIT&quot;))&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rmap_omit&#39;</span> <span class="p">:</span> <span class="s1">&#39;((DETECTOR != &quot;SBC&quot;) and (BIASCORR != &quot;OMIT&quot;))&#39;</span><span class="p">,</span>

    <span class="s1">&#39;parkey_relevance&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;binaxis1&#39;</span> <span class="p">:</span> <span class="s1">&#39;(DETECTOR == &quot;UVIS&quot;)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;binaxis2&#39;</span> <span class="p">:</span> <span class="s1">&#39;(DETECTOR == &quot;UVIS&quot;)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ccdgain&#39;</span> <span class="p">:</span> <span class="s1">&#39;(DETECTOR == &quot;IR&quot;)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;samp_seq&#39;</span> <span class="p">:</span> <span class="s1">&#39;(DETECTOR == &quot;IR&quot;)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;subtype&#39;</span> <span class="p">:</span> <span class="s1">&#39;(DETECTOR == &quot;IR&quot;)&#39;</span><span class="p">,</span>
    <span class="p">},</span>

    <span class="s1">&#39;hooks&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;fallback_header&#39;</span> <span class="p">:</span> <span class="s1">&#39;fallback_header_acs_biasfile_v2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;precondition_header&#39;</span> <span class="p">:</span> <span class="s1">&#39;precondition_header_acs_biasfile_v2&#39;</span><span class="p">,</span>
    <span class="p">},</span>

          <span class="o">...</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="required-parameters">
<h3>Required Parameters<a class="headerlink" href="#required-parameters" title="Permalink to this headline">¶</a></h3>
<p>Required matching parameters for computing best references are defined by the union of 3 header fields:  <em>parkey</em>,
<em>extra_keys</em>, and  <em>reffile_switch</em>.   There is no requirement to use all 3 forms,  the latter two forms were added
to model and emulate aspects of HST’s CDBS system,  the precursor to CRDS.</p>
<div class="section" id="parkey">
<h4>parkey<a class="headerlink" href="#parkey" title="Permalink to this headline">¶</a></h4>
<p>The primary location for defining best references matching parameters is the <em>parkey</em> field.</p>
<p>The simplest form of <em>parkey</em> is a tuple of parameter names used in a lookup by a non-nested selector,  as is
seen in pipeline and instrument mappings above.</p>
<p>In reference mappings,  the header <em>parkey</em> field is a tuple of tuples.  Each stage of the nested selector
consumes the next tuple of header keys.  The same parameter set and matching structure is shared by all sections
of a single rmap.   For mode-specific parameters,  two approaches are availble:  use a separate .rmap for each
parameter combination, or fill in unused parameters for a particular mode with the value ‘N/A’.</p>
<p>For the HST COS DEADTAB example above,   the Match operator matches against the value of the dataset keyword
‘DETECTOR’.   Based on that match, the selected UseAfter operator matches against the dataset’s ‘DATE-OBS’ and
‘TIME-OBS’ keywords to lookup the name of a reference file.</p>
<p>There is no default for parkey.</p>
</div>
<div class="section" id="extra-keys">
<h4>extra_keys<a class="headerlink" href="#extra-keys" title="Permalink to this headline">¶</a></h4>
<p><em>extra_keys</em> specifies a tuple of parameter names which will not be used in the matches directly,  but may be used by
rmap header expressions and hook functions to influence matching.  Listing parameters in extra_keys ensures that the
CRDS infrastructure will request the parameters from the server or dataset files and make them available during best
references computations and logical expression evaluation.   All parameters used in logical expressions must be
explicitly defined and listed.   Undefined parameters are evaluated with the value ‘UNDEFINED’.</p>
<p>If omitted, <em>extra_keys</em> defaults to (),  no extra keys.</p>
</div>
<div class="section" id="reffile-switch">
<h4>reffile_switch<a class="headerlink" href="#reffile-switch" title="Permalink to this headline">¶</a></h4>
<p>Nominally names a dataset keyword generally of the form &lt;type&gt;CORR with keyword values ‘PERFORM’ and ‘OMIT’.</p>
<p>If <em>reffile_switch</em> is not ‘NONE’,  it specifies an extra keyword value is to fetch from the dataset.</p>
<p>If <em>reffile_switch</em> is omitted or ‘NONE’,  no keyword value is fetched from the dataset.</p>
<p>The runtime checking <em>reffile_switch</em> is used for must be explicitly implemented as part of an <em>rmap_relevance</em> or
<em>rmap_omit</em> expression as seen in the example header; <em>reffile_switch</em> only specifies an extra parameter to fetch
for use in logical expressions and matching.  It is logically equivalent to adding the parameter to <em>extra_keys</em>.</p>
</div>
</div>
<div class="section" id="logical-header-expressions">
<h3>Logical Header Expressions<a class="headerlink" href="#logical-header-expressions" title="Permalink to this headline">¶</a></h3>
<p>A number of the subsequently described features employ logical expressions which are evaluated at match-time
based on the values in the dataset header.  There are several things to point out:</p>
<ul class="simple">
<li>Logical expressions are evaluated in the context of the required parameters discussed above.</li>
<li>Dataset matching parameters appear in logical expressions in upper case,  without quotes, like global variables.</li>
<li>The entire expression is enclosed in parentheses to tell CRDS to leave case as-is.</li>
<li>Logical expressions are limited to a restricted subset of Python expressions,  not arbitrary Python.  In particular
arbitrary Python function calls are not permitted.</li>
</ul>
</div>
<div class="section" id="reffile-required">
<h3>reffile_required<a class="headerlink" href="#reffile-required" title="Permalink to this headline">¶</a></h3>
<p>Defines what should happen if an rmap lookup cannot find a match for a particular reference type.</p>
<p><em>reffile_required</em> has legal values ‘YES’, ‘NO’, and ‘NONE’.</p>
<p>If <em>reffile_required</em> is ‘YES’, failing to find a match results in an exception and/or ERROR.</p>
<p>If <em>reffile_required</em> is ‘NONE’, CDBS did not define <em>reffile_required</em> for this type, so it is assumed to be required.</p>
<p>If <em>reffile_required</em> is ‘NO’,  failing to find a match results in assigning the value ‘N/A’ rather than failing.</p>
</div>
<div class="section" id="rmap-relevance">
<h3>rmap_relevance<a class="headerlink" href="#rmap-relevance" title="Permalink to this headline">¶</a></h3>
<p><em>rmap_relevance</em> is a logical expression which is evaluated in the context of dataset header variables.</p>
<p>If <em>rmap_relevance</em> evaluates to True, then a full match is performed and the resulting bestref is returned.</p>
<p>If <em>rmap_relevance</em> evaluates to False, then the match is short circuited and ‘N/A’ is assigned.</p>
</div>
<div class="section" id="parkey-relevance">
<h3>parkey_relevance<a class="headerlink" href="#parkey-relevance" title="Permalink to this headline">¶</a></h3>
<p><em>parkey_relevance</em> defines a mapping from dataset matching parameters to logical expressions.</p>
<p><em>parkey_relevance</em> is evaluated in the context of the entire set of matching parameters and mutates
the specified parameter to ‘N/A’ if the expression evaluates to False,  i.e. the parameter is not relevant
in the context of the other parameter values.</p>
<p>When a parameter value of ‘N/A’ is used for matching, the parameter is effectively ignored.</p>
</div>
<div class="section" id="hooks">
<h3>hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h3>
<p>The <em>hooks</em> header section defines functions which are used for special case processing for complex reference
assignments.   The existing hooks were devised to emulate similar special case handling performed by CRDS’s
predecessor system CDBS.</p>
<p>The original &lt;100 series of HST rules had implicit hooks.  CRDS rules &gt;200 have hooks which are explicitly
named in the ‘hooks’ section of the header which indicates that customized matching is being performed.   Running
crds.bestrefs with –verbosity=60 wil issue log messages describing hook operations.</p>
<p>new hook functions can only be added with a new release of CRDS code.   hook functions have versioned names and should
never be modified after use in operations since that would change the meaning of historical .rmaps.  Instead,  a new
hook function should be added and the .rmap header modified to assign it.</p>
<p>hook functions can be ‘unplugged’ in an operational .rmap by setting the value of the hook to ‘none’.  Removing the
‘hooks’ section of the .rmap header, or removing individual hook names, currently results in reversion to &lt;100 series
.rmap behavior and the original implicit hook functions.</p>
<div class="section" id="precondition-header">
<h4>precondition_header<a class="headerlink" href="#precondition-header" title="Permalink to this headline">¶</a></h4>
<p>The <em>precondition_header</em> hook is used to mutate incoming dataset matching parameters.   <em>precondition_header</em> is
sometimes justified as reductive,  written in terms of <em>extra_parkeys</em> which do not appear in the matching tuples,
and used to mutate a broad range of matching parameter values onto a narrower set of parameter values known to be
handled in the .rmap.   In essence,  when a <em>precondition_header</em> hook is used,  the dataset matching parameters
become a function of themselves.</p>
</div>
<div class="section" id="fallback-header">
<h4>fallback_header<a class="headerlink" href="#fallback-header" title="Permalink to this headline">¶</a></h4>
<p>The <em>fallback_header</em> hook is used to mutate incoming dataset matching parameters similar to <em>precondition_header</em>.
The <em>fallback_header</em> hook is called when the first matching attempt for dataset parameters fails.  <em>fallback_header</em>
computes a set of matching parameters used for a second matching attempt which will return normally if succesful.</p>
</div>
</div>
</div>
<div class="section" id="selectors">
<h2>Selectors<a class="headerlink" href="#selectors" title="Permalink to this headline">¶</a></h2>
<p>All the CRDS selection operators are written to select either a return
value <em>or</em> a nested operator.  In the case of HST, the Match operator locates a
nested UseAfter operator which in turn locates the reference file.</p>
<div class="section" id="primitive-return-values">
<h3>Primitive Return Values<a class="headerlink" href="#primitive-return-values" title="Permalink to this headline">¶</a></h3>
<p>Ultimately the result of every selector lookup is some form of return value to
which various CRDS operations can be applied: best references assignment, file
distribution, file certification, file differencing, etc.</p>
<div class="section" id="single-filename">
<h4>Single Filename<a class="headerlink" href="#single-filename" title="Permalink to this headline">¶</a></h4>
<p>The most typical return value is a single reference filename.  In the case of
GEIS files, for the data+header file pair the header is specified in rmaps but
both components are distributed.</p>
</div>
<div class="section" id="filename-tuple">
<h4>Filename Tuple<a class="headerlink" href="#filename-tuple" title="Permalink to this headline">¶</a></h4>
<p>A tuple of primitive filenames can be specified.  All files in the tuple are
synchronized and returned as best references.  The nominal application of a
file tuple is for the bracket selector where the files are used for pipeline
side interpolations between the two references to generate a synthetic
reference.</p>
</div>
<div class="section" id="not-applicable">
<h4>Not Applicable<a class="headerlink" href="#not-applicable" title="Permalink to this headline">¶</a></h4>
<p>A value of N/A can be assigned in place of a filename.  This applies the full
power of the matching system to the specification of instrument modes for which
a reference type does not apply.  For JWST this feature is used to perform data
driven WCS processing based on CRDS reference file assignments.  Ultimately the
best reference assigned is N/A, nominally explicitly recorded for the type
keyword.  No file is distributed or prefetched.  N/A may be specified in place
of a reference file or an rmap file.  In the case of specifying N/A for an rmap
file (in the imap/instrument mapping), that type becomes N/A for all modes of
that instrument.</p>
</div>
<div class="section" id="omit">
<h4>Omit<a class="headerlink" href="#omit" title="Permalink to this headline">¶</a></h4>
<p>Similar to N/A, a value of OMIT can be specified in place of a filename.  OMIT
can be used to completely remove a type from the best references response.  No
file is synchronized or processed, and no best reference should be recorded in
the dataset header for that type.  This feature is currently unused.</p>
</div>
</div>
<div class="section" id="match">
<h3>Match<a class="headerlink" href="#match" title="Permalink to this headline">¶</a></h3>
<p>Based on a dataset`s header values,  Match locates the match tuple which best matches the dataset.   Conceptually this
is a dictionary lookup.   In actuality, CRDS processes each match parameter in succession,  at each step eliminating
match candidates that cannot possibly match.</p>
<div class="section" id="parameter-tuples-and-simple-matches">
<h4>Parameter Tuples and Simple Matches<a class="headerlink" href="#parameter-tuples-and-simple-matches" title="Permalink to this headline">¶</a></h4>
<p>The CRDS Match operator typically matches a dataset header against a tuple which defines multiple parameter values whose
names are specified in the rmap header <code class="xref py py-obj docutils literal"><span class="pre">parkey</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;UVIS&quot;</span><span class="p">,</span> <span class="s2">&quot;F122LP&quot;</span><span class="p">)</span>   <span class="p">:</span>  <span class="s1">&#39;some_file_or_nested_selection&#39;</span>
</pre></div>
</div>
<p>Alternately,  for simple use cases the Match operator can match against single
strings,  which is a simplified syntax for a 1-tuple:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;UVIS&#39;</span>  <span class="p">:</span>  <span class="s1">&#39;some_file_or_nested_selection&#39;</span>
<span class="p">(</span><span class="s1">&#39;UVIS&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="s1">&#39;this_is_the_equivalent_one_tuple&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="single-parameter-values">
<h4>Single Parameter Values<a class="headerlink" href="#single-parameter-values" title="Permalink to this headline">¶</a></h4>
<p>Each value within the match tuples of a Match operator can be an expression in its own right.   There are a number of
special values associated with each match expression:  Ors |, Wildcards *,  Regular Expressions (), Literals {},
Relationals, between, N/A, and Substitutions.</p>
</div>
<div class="section" id="or">
<h4>Or |<a class="headerlink" href="#or" title="Permalink to this headline">¶</a></h4>
<p>Many CRDS match expressions consist of a series of match patterns separated by vertical bars.   The vertical bar is read
as “or” and means that a match occurs if either pattern matches that dataset header.   For example, the expression:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;either_this|that&quot;</span><span class="p">,</span><span class="s2">&quot;1|2|3&quot;</span><span class="p">)</span>  <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>will match:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;either_this&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and also:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;that&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="wild-cards">
<h4>Wild Cards *<a class="headerlink" href="#wild-cards" title="Permalink to this headline">¶</a></h4>
<p>By default,  * is interpreted in CRDS as a glob pattern,  much like UNIX shell file name matching.  * matches any
sequence of characters.  The expression:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;F*122&quot;</span><span class="p">,)</span> <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>will match any value starting with “F” and ending with “122”.</p>
</div>
<div class="section" id="regular-expressions">
<h4>Regular Expressions<a class="headerlink" href="#regular-expressions" title="Permalink to this headline">¶</a></h4>
<p>CRDS can match on true regular expressions.   A true regular expression match is
triggered by bracketing the match in parentheses ():</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;(^F[^13]22$)&quot;</span><span class="p">,)</span>  <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>The above corresponds to matching the regular expression “^F[^1234]22$” (note that the bracketing parentheses within the
string are removed.)   Regular expression syntax is explained in the Python documentation for the re module. The above
expression will match values starting with “F”, followed by any character which is not “1” or “3” followed by “22”.</p>
</div>
<div class="section" id="literal-expressions">
<h4>Literal Expressions<a class="headerlink" href="#literal-expressions" title="Permalink to this headline">¶</a></h4>
<p>A literal expression is bracketed with curly braces {} and is matched without
any interpretation whatsoever.   Hence,  special characters like * or | are
interpreted literally rather than as ors or wildcards.  The expression:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;{F|*G}&quot;</span><span class="p">,)</span> <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>matches the value “F|*G” as opposed to “F” or anything ending with “G”.</p>
</div>
<div class="section" id="relational-expressions">
<h4>Relational Expressions<a class="headerlink" href="#relational-expressions" title="Permalink to this headline">¶</a></h4>
<p>Relational expressions are bracketed by the pound character #.   Relational
expressions do numerical comparisons on the header value to determine a match.
Relational expressions have implicit variables and support the operators:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">&gt;=</span> <span class="o">&lt;</span> <span class="o">&lt;=</span> <span class="o">==</span> <span class="ow">and</span> <span class="ow">or</span>
</pre></div>
</div>
<p>The expression:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;# &gt;1 and &lt;37 #&quot;</span><span class="p">,)</span>  <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>will match any number greater than 1 and less than 37.</p>
</div>
<div class="section" id="between">
<h4>Between<a class="headerlink" href="#between" title="Permalink to this headline">¶</a></h4>
<p>A special relational operator “between” is used to simply express a range
of numbers &gt;= to the lower bound and &lt; the upper bound,  similar to Python
slicing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;between 1  47&quot;</span><span class="p">,)</span> <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>will match any number greater than or equal to 1 and less than 47.   This is
equivalent to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;# &gt;=1 and &lt;47 #&quot;</span><span class="p">,)</span> <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>Note that “between” matches sensibly stack into a complete range.  The expressions:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;between 1 47&quot;</span><span class="p">,)</span> <span class="p">:</span> <span class="s2">&quot;some_file.fits&quot;</span>
<span class="p">(</span><span class="s2">&quot;between 47 90&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;another_file.fits&quot;</span>
</pre></div>
</div>
<p>provide complete coverage for the range between 1 and 90.</p>
</div>
<div class="section" id="n-a">
<h4>N/A<a class="headerlink" href="#n-a" title="Permalink to this headline">¶</a></h4>
<p>Some rmaps have match tuple values of “N/A”,  or Not Applicable.
A value of N/A is matched as a special version of “*”, matching anything,  but
not affecting the “weight” of the match:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;HRC&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span> <span class="p">:</span>  <span class="s2">&quot;some_file.fits&quot;</span>
</pre></div>
</div>
<p>There are a couple uses for N/A parameters.    First,  sometimes a parameter is
irrelevant in the context of the other parameters.   So for an rmap which covers
multiple instrument modes,  a parameter may not apply to all modes. Second,
sometimes a parameter is relevant to custom lookup code,  but is not used by the
match directly.  In this second case,   the “N/A” parameter may be used by custom
header preconditioning code to assist in mutating the other parameter values
that <em>are</em> used in the match.</p>
</div>
<div class="section" id="not-expressions">
<h4>NOT Expressions<a class="headerlink" href="#not-expressions" title="Permalink to this headline">¶</a></h4>
<p>It’s possible to match the negation of match expressions by pre-pending “NOT ”
to the unnegated expression.   For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;not HRC&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span> <span class="p">:</span>  <span class="s2">&quot;not_some_file.fits&quot;</span>
</pre></div>
</div>
<p>The weight of a negated expression is the opposite of unnegated weight of the
expression: -1 -&gt; 1, 1 -&gt; -1, 0 -&gt; 0.</p>
</div>
<div class="section" id="substitution-parameters">
<h4>Substitution Parameters<a class="headerlink" href="#substitution-parameters" title="Permalink to this headline">¶</a></h4>
<p>Substituion parameters are short hand notation which eliminate the need to
duplicate rmap rules.  In order to support WFC3 biasfile conventions,  CRDS
rmaps permit the definition of meta-match-values which correspond to a set of
actual dataset header values. For instance,  when an rmap header contains a
“substitutions” field like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;substitutions&#39;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;CCDAMP&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;G280_AMPS&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ABCD&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;AD&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">,</span> <span class="s1">&#39;BD&#39;</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">},</span>
</pre></div>
</div>
<p>then a match tuple line like the following could be written:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;UVIS&#39;</span><span class="p">,</span> <span class="s1">&#39;G280_AMPS&#39;</span><span class="p">,</span> <span class="s1">&#39;1.5&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;G280-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
</pre></div>
</div>
<p>Here the value of G280_AMPS works like this:  first,   reference files listed
under that match tuple define CCDAMP=G280_AMPS.   Second, datasets which should
use those references define CCDAMP to a particular amplifier configuration,
e.g.  ABCD.   Hence,  the reference file specifies a set of applicable
amplifier configurations,  while the dataset specifies a particular
configuration.   CRDS automatically expands substitutions into equivalent sets
of match rules.</p>
</div>
<div class="section" id="match-weighting">
<h4>Match Weighting<a class="headerlink" href="#match-weighting" title="Permalink to this headline">¶</a></h4>
<p>Because of the presence of special values like regular expressions, CRDS uses a
winnowing match algorithm which works on a parameter-by-parameter basis by
discarding match tuples which cannot possibly match. After examining all
parameters,   CRDS is left with a list of candidate matches.</p>
<p>For each literal, *, or regular expression parameter that matched,  CRDS
increases its sense of the goodness of the match by 1.   For each N/A that was
ignored, CRDS doesn’t change the weight of the match.   The highest ranked match
is the one CRDS chooses as best.   When more than one match tuple has the same
highest rank, we call this an “ambiguous” match.   Ambiguous matches will
either be merged,  or treated as errors/exceptions that cause the match to fail.
Talk about ambiguity.</p>
<p>For the initial HST rmaps, there are a number of match cases which overlap,
creating the potential for ambiguous matches by actual datasets.   For HST,  all
of the match cases refer to nested UseAfter selectors.  A working approach for
handling ambiguities here is to merge the two or more equal weighted UseAfter
lists into a single combined UseAfter which is then searched.</p>
<p>The ultimate goal of CRDS is to produce clear non-overlapping rules.  However,
since the initial rmaps are generated from historical mission data in CDBS,
there are eccentricities which need to be accomodated by merging or eventually
addressed by human beings who will simplify the rules by hand.</p>
</div>
</div>
<div class="section" id="useafter">
<h3>UseAfter<a class="headerlink" href="#useafter" title="Permalink to this headline">¶</a></h3>
<p>The UseAfter selector matches an ordered sequence of date time values to
corresponding reference filenames.   UseAfter finds the greatest date-time which
is less than or equal to ( &lt;= ) EXPSTART of a dataset.   Unlike
reference file and dataset timestamp values,  all CRDS rmaps represent times in
the single format shown in the rmap example below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">Match</span><span class="p">({</span>
   <span class="p">(</span><span class="s1">&#39;HRC&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
       <span class="s1">&#39;1991-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s1">&#39;j4d1435hj_a2d.fits&#39;</span><span class="p">,</span>
       <span class="s1">&#39;1992-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s1">&#39;kcb1734ij_a2d.fits&#39;</span><span class="p">,</span>
   <span class="p">}),</span>
   <span class="p">(</span><span class="s1">&#39;WFC&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
       <span class="s1">&#39;1991-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s1">&#39;kcb1734hj_a2d.fits&#39;</span><span class="p">,</span>
       <span class="s1">&#39;2008-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s1">&#39;t3n1116mj_a2d.fits&#39;</span><span class="p">,</span>
   <span class="p">}),</span>
<span class="p">})</span>
</pre></div>
</div>
<p>In the above mapping,  when the detector is HRC,  if the dataset’s date/time
is before 1991-01-01,  there is no match.   If the date/time is between
1991-01-01 and 1992-01-01,  the reference file ‘j4d1435hj_a2d.fits’ is matched.
If the dataset date/time is 1992-01-01 or after,  the recommended reference
file is ‘kcb1734ij_a2d.fits’</p>
</div>
<div class="section" id="selectversion">
<h3>SelectVersion<a class="headerlink" href="#selectversion" title="Permalink to this headline">¶</a></h3>
<p>The SelectVersion() rmap operator uses a software version and various relations
to make a selection:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SelectVersion</span><span class="p">({</span>
   <span class="s1">&#39;&lt;3.1&#39;</span><span class="p">:</span>    <span class="s1">&#39;cref_flatfield_65.fits&#39;</span><span class="p">,</span>
   <span class="s1">&#39;&lt;5&#39;</span><span class="p">:</span>      <span class="s1">&#39;cref_flatfield_73.fits&#39;</span><span class="p">,</span>
   <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;cref_flatfield_123.fits&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>While similar to relational expressions in Match(),   SelectVersion() is
dedicated, simpler,  and more self-documenting.  With the exception of default,
versions are examined in sorted order.</p>
</div>
<div class="section" id="closesttime">
<h3>ClosestTime<a class="headerlink" href="#closesttime" title="Permalink to this headline">¶</a></h3>
<p>The ClosestTime() rmap operator does a lookup on a series of times and selects
the closest time which either precedes or follows the given parameter value:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">ClosestTime</span><span class="p">({</span>
     <span class="s1">&#39;2017-04-24 00:00:00&#39;</span><span class="p">:</span>  <span class="s2">&quot;cref_flatfield_123.fits&quot;</span><span class="p">,</span>
     <span class="s1">&#39;2018-02-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s2">&quot;cref_flatfield_222.fits&quot;</span><span class="p">,</span>
     <span class="s1">&#39;2019-04-15 00:00:00&#39;</span><span class="p">:</span>  <span class="s2">&quot;cref_flatfield_123.fits&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>So a parameter of ‘2017-04-25 00:00:00’ would select ‘cref_flatfield_123.fits’.</p>
</div>
<div class="section" id="geometricallynearest">
<h3>GeometricallyNearest<a class="headerlink" href="#geometricallynearest" title="Permalink to this headline">¶</a></h3>
<p>The GeometricallyNearest() selector applies a distance relation between a
numerical parameter and the match values.   The match value which is closest to
the supplied parameter is chosen:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">GeomtricallyNearest</span><span class="p">({</span>
    <span class="mf">1.2</span> <span class="p">:</span> <span class="s2">&quot;cref_flatfield_120.fits&quot;</span><span class="p">,</span>
    <span class="mf">1.5</span> <span class="p">:</span> <span class="s2">&quot;cref_flatfield_124.fits&quot;</span><span class="p">,</span>
    <span class="mf">5.0</span> <span class="p">:</span> <span class="s2">&quot;cref_flatfield_137.fits&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>In this case,  a value of 1.3 would match ‘cref_flatfield_120.fits’.</p>
</div>
<div class="section" id="bracket">
<h3>Bracket<a class="headerlink" href="#bracket" title="Permalink to this headline">¶</a></h3>
<p>The Bracket() selector is unusual because it returns the pair of selections which
enclose the supplied parameter value:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">Bracket</span><span class="p">({</span>
    <span class="mf">1.2</span><span class="p">:</span> <span class="s2">&quot;cref_flatfield_120.fits&quot;</span><span class="p">,</span>
    <span class="mf">1.5</span><span class="p">:</span> <span class="s2">&quot;cref_flatfield_124.fits&quot;</span><span class="p">,</span>
    <span class="mf">5.0</span><span class="p">:</span> <span class="s2">&quot;cref_flatfield_137.fits&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Here,  a parameter value of 1.3 returns the value:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;cref_flatfield_120.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;cref_flatfield_124.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="library_use.html" class="btn btn-neutral float-right" title="Library Use" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="web_services.html" class="btn btn-neutral" title="Web Services" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Space Telescope Science Institute.
      Last updated on Mar 04, 2018.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'7.1.7',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>