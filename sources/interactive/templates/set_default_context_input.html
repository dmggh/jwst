{% extends "base.html" %}

{% block contents_both %}
<h2 title="Set the context used in the pipeline by default (operational) or
           as the default starting point for the next file submission (edit)"
    >Set Context</h2>
<form method="post" action="/set_default_context/"
      enctype="multipart/form-data" 
      onsubmit="return crds.validate_set_context(this);" >  {% csrf_token %}
  
  <div  title="Choose type of context to set, operational (pipeline) or edit">
    <h3>Select:</h3>
    <table border='1' width="100%">
      <tr>
        <th title="Type of context to set"
            >Context Type</th>
        <th title="Current value of selected context type."
            >Current Value</th>
      </tr>
      <tr>
        <td>
          <select name="context_type" id="context_type" onchange="crds.set_context_display($('#context_type').val());">
            {% for ctype in context_types %}
            {% if ctype == "operational" %}
            <option selected>{{ctype}}</option>
            {% else %}
            <option>{{ctype}}</option>
            {% endif %}
            {% endfor %}
          </select>
        </td>
        <td id='context_display' class="gray"></td>
      </tr>
    </table>
  </div>
  
  <div title="Value to set the selected context type to.">
    <h3>Set To:</h3>
    {% include "select_pmap.html" %}
  </div>
  
  <div title="Describe content or reason for this context transition.">
    <h3>Reason for Change:</h3>
    <p><textarea name="description" id="description" rows="4" cols="50">{{description}}</textarea></p>
    <br/>
  </div>
  
  <input class="btn btn-primary" type="submit" value="Set Default Context"/>

</form>

<br/><br/>
{% include "bluebar.html" %}

<div>
  <br/>
  <p><b>Reason For Change:</b> Shown in the <b>context history</b>.  For single
    context increments, the reason is defaulted from the file submission
    description but may be changed here.  For multi-context increments or
    reversals, the reason must be added manually.
  </p>
  
  <p><b>Operational</b> Drives default <b>pipeline best references</b>.  The
    pipeline's CRDS cache must be sync'ed for this to take effect.  The
    operational context cannot contain bad files.  Generally set following each
    reference file delivery.
  </p>
  
  <p><b>Edit</b> Drives default <b>file submission</b> context generation. Generally
    set for branching context development or custom context submissions.
  </p>
</div>

    <script type="text/javascript">
        crds.context_map = {
            {% for context in context_map.items %}
                "{{context.0}}" : "{{context.1}}",
            {% endfor %}
        };
        crds.context_pmaps = {
            {% for pmap in context_pmaps.items %}
                "{{pmap.0}}" : "{{pmap.1}}",
            {% endfor %}
        };

        crds.set_context_display = function(value) {
	    console.log("set_context_display " + value);
            $('#context_display').html(crds.context_pmaps[crds.context_map[value]]);
        };
        crds.set_context_display("operational");
        
        crds.validate_set_context = function () {
            console.log("Validating set context.");
            if (!crds.validate_select_pmap()) {
               return false;
            };
            console.log("Validating description.");
            if (!$("#description").val()) {
                alert("Did you add a Description?");
                return false;
            };
            $("input[type=submit]").hide();
            crds.set_info_box({text: "Switching context now."});
            crds.append_info_box({
                    text: "This may take a few minutes to update file activation dates.",
                    css: {color: "darkblue"},
                    });
            return true;
        };

    </script>
    
{% endblock contents_both %}
