{% extends "base.html" %}

{% block contents_both %}
    <h2>Set Context</h2>
    <form method="post" action="/set_default_context/" enctype="multipart/form-data" onsubmit="return crds.warn_delay();" >  {% csrf_token %}

      <h3>Select:</h3>
      <table border='1'>
            <tr>
                <th>Context Type</th>
                <th>Current Value</th>
            </tr>
            <tr>
                <td>
                    <select name="context_type" id="context_type" onchange="crds.set_context_display($('#context_type').val());">
                        {% for ctype in context_types %}
                            {% if ctype == "operational" %}
                                <option selected>{{ctype}}</option>
                            {% else %}
                                <option>{{ctype}}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </td>
                <td id='context_display' class="gray"></td>
            </tr>
      </table>

      <h3>Set To:</h3>
      {% include "select_pmap.html" %}
      
      <h3>Reason for Change:</h3>
      <p><textarea name="description" id="description" rows="4" cols="50">{{description}}</textarea></p>
      <br/>

      <input class="btn btn-primary" type="submit" value="Set Default Context" />
    </form>
    
    <script type="text/javascript">
        crds.context_map = {
            {% for context in context_map.items %}
                "{{context.0}}" : "{{context.1}}",
            {% endfor %}
        };
        crds.context_pmaps = {
            {% for pmap in context_pmaps.items %}
                "{{pmap.0}}" : "{{pmap.1}}",
            {% endfor %}
        };
        crds.set_context_display = function(value) {
	    console.log("set_context_display " + value);
            $('#context_display').html(crds.context_pmaps[crds.context_map[value]]);
        };
        crds.set_context_display("operational");
        
        crds.warn_delay = function () {
            crds.set_info_box({text: "Switching operational context now."});
            crds.append_info_box({
                    text: "This may take a few minutes to update file activation dates.",
                    css: {color: "darkblue"},
                    });
            return true;
        };
    </script>
    
{% endblock contents_both %}

{% block help %}

<p><b>Set Context</b> is typically used to define the context which will be
  used by the operational pipeline.  Set Context can also be used to modify the
  editing context from which new contexts will be derived by default during
  file submissions.

<p><b>Select:</b> Choose the type of default to modify, operational or edit.
This also shows the current default of the selected type.  Normally select
operational to update pipeline context use, use edit to set the default
starting point for file submissions.

<p><b>Set To:</b> The context of the selected type will be set to this value.
Click on the Set To accordion to see other options for choosing the value.

<p><b>Reason For Change:</b> Reason why context is being set. This is shown 
in the context history.   For single context increments,  the reason is carried
over from the file submission page.   For multi-context increments,  the
operator or submitters must make up an appropriate summary.
</p>

<p><b>Operational</b> Defines default pmap which will be used
operationally to determine best references.  The operational context cannot
contain blacklisted references.

<p><b>Edit</b> Defines default starting point (derive from) for future contexts
created by the server as a result of file submissions.

{% endblock help %}
