{% extends "base.html" %}

{% load stdtags %}

{% block contents %}

<script type="text/javascript">

$( function () {
    
    console.log("initing.")
    
    var add_count = 0;    
    var del_count = 0;
    
    parse_useafter = function (button) {
        match_tuple = button.parent().parent().children().html().split(":")[0];
        match_tuple = match_tuple.slice(match_tuple.indexOf("("), match_tuple.length);
        match_tuple = $.trim(match_tuple);
        filename = button.siblings().slice(1,-1).text().slice(1,-1);
        date = button.parent().find("span").text().slice(1, -1);
        console.log("match tuple: " + match_tuple + 
                    " useafter: " + date + 
                    " filename: " + filename);
        return {
            match_tuple: match_tuple,
            date: date,
            filename: filename,
        }
    }
    
    mk_input = function (type, name, value) {
        hidden = '<input type="' + type + '" name="' +
                 name + '" value="' + value +'">'
        console.log(hidden)
        return hidden
    }
    
    add_useafter = function (event) {
        console.log("add_useafter");
        button = $(event.target);
        
        match_tuple = parse_useafter(button).match_tuple;
        
        name_prefix = "add." + add_count++;
        
        input_bundle = $("<p class='dynamic'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +
            mk_input("text", name_prefix + ".date", '') + " : " +
            mk_input("text", name_prefix + ".filename", '') + 
            mk_input("hidden", name_prefix + ".match_tuple", match_tuple) +    
            "<button class='add' type='button'>+</button>" + 
            "<button class='del' type='button'>-</button>" + 
            "</p>");
                 
        $("button[class=add]", input_bundle).click(add_useafter)
        $("button[class=del]", input_bundle).click(del_useafter_dynamic)
        
        $("input[name$=date]", input_bundle).change(validate_useafter);
        $("input[name$=filename]", input_bundle).change(validate_filename);
        
        button.parent().after(input_bundle);

    }
    
    del_useafter_static = function(event) {
        console.log("del_useafter");
        button = $(event.target);
        button.siblings().slice(1,-1)
            .css("text-decoration", "line-through")
            .css("color", "red");

        parsing = parse_useafter(button)

        name_prefix = "delete." + del_count++;

        p = button.parent();
        $("<div class='dynamic' style='display:none'>" + 
          mk_input("hidden", name_prefix + ".match_tuple", parsing.match_tuple) + 
          mk_input("hidden", name_prefix + ".date", parsing.date) +
          mk_input("hidden", name_prefix + ".filename", parsing.filename) +
          "</div>")
          .appendTo(p);

        button.remove();
        $("button[class=add]", p)
            .unbind("click")
            .click(undel_useafter);
    }
    
    del_useafter_dynamic = function(event) {
        console.log("del_useafter_dynamic");
        button = $(event.target);
        button.parent().remove();
    }
    
    undel_useafter = function(event) {
        console.log("undel_useafter");
        button = $(event.target);
        button.siblings().slice(1,-1)
            .css("text-decoration", "none")
            .css("color", "blue");
        p = button.parent();
        $("input[name^=delete]", p).remove();
        button.remove();
        $("<button class='add' type='button'>+</button>")
            .appendTo(p)
            .click(add_useafter)
        $("<button class='del' type='button'>-</button>")
            .appendTo(p)
            .click(del_useafter_static)
    }

    var edit_flag = false;
    
    $("button#edit_rmap").click( function (event) {
        console.log("edit_rmap");
        edit_flag = true;
        $("<br/> <input type='submit' value='Submit Rmap Update'/>")
            .appendTo("form#update_rmap_form");
        $("button#edit_rmap").hide();
        $("button#unedit_rmap").show();
        $("span#edit_help").show();
    });

    unedit_button = $("<button type='button' id='unedit_rmap'>Forget Edits</button>")
        .click( function (event) {
            console.log("unedit_rmap");
            edit_flag = false;
            $(".dynamic").remove();
            $("button.add").remove();
            $("button.del").remove();
            $("a[href*='browse']")
                .css("text-decoration","none")
                .css("color","blue");
            $("form#update_rmap_form input[type=submit]").remove();
            $("button#unedit_rmap").hide();
            $("span#edit_help").hide()
            $("button#edit_rmap").show();
        })
        .hide();
    $("button#edit_rmap").after(unedit_button);
    $("button#unedit_rmap").after(
        $("<span>")
            .attr("id","edit_help")
            .addClass("help")
            .text("  Click on a useafter date to edit.")
            .hide()
    );
    
    /* Use the form click handler to land events anywhere in the form. Only
    process clicks which are in a useafter line and not on a file link.  Add
    or remove buttons on click.
    */
    $("form#update_rmap_form").click( function (event) {
        console.log("update_rmap_form ");
        if (!edit_flag) {
            console.log("editing disabled.")
            return true;
        }
        point = $(event.target);
        console.log(point);
        p = point.parent();
        div = p.parent();
        if (!point.length || point[0].nodeName == "A") {
            console.log("skipping browse link");
            return true;
        }
        if (!p.length || p[0].nodeName != "P") {
            console.log("non-P parent");
            return true;
        }
        if (!div.length || div[0].nodeName != "DIV") {
            console.log("DIV not found");
            return true;
        }
        if (!div.hasClass("useafter")) {
            console.log("useafter not found");
            return true;
        }
        if (!p.find("a").length) {
            console.log("no anchor");
            return true;
        }
        if (p.find("button").length) {
            $("button",p).remove()
        } else {
            $("<button class='add' type='button'>+</button>")
                .click(add_useafter)
                .appendTo(p);
            $("<button class='del' type='button'>-</button>")
                .click(del_useafter_static)
                .appendTo(p);
        }
    });
    
    assert = function (exp, message) {
        if (!exp) {
            throw message;
        }
    }

    assert_range = function (name, value, min, max) {
        assert( (value) >= min && (value <= max), 
                "Invalid " + name + " = " + value + 
                " must be in range " + min + " .. " + max + ".");
    }

    DATETIME_RE = /^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d$/;

    MONTHS = {"01":1,"02":1,"03":1,"04":1,"05":1,"06":1,"07":1,"08":1,"09":1,"10":1,"11":1,"12":1};
    
    check_datetime = function (datetime) {
        try {
            assert(DATETIME_RE.test(datetime), 
                "datetime must match general format  yyyy-mm-dd hh:mm:ss");

            parts = datetime.split(" ");
 
            date = parts[0].split("-")
            year = date[0];
            month = date[1];
            day = date[2];
            
            hms = parts[1].split(":");
            hours = hms[0];
            minutes = hms[1];
            seconds = hms[2];

            assert_range("year", year, "1990", "2050");
            assert_range("month", month, "01", "12");
            assert_range("day", day, "01", "31");
            
            assert_range("hours", hours, "00", "12");
            assert_range("minutes", minutes, "00", "59");
            assert_range("seconds", seconds, "00", "59");

            return [true, "datetime is valid."]
        } catch (err) {
            return [false, err];
        }
    }
    
    validate_useafter = function (event) {
        console.log("validate_useafter");
        input = $(event.target);
        datetime = input.val();
        if (!datetime.length) {
            console.log("empty datetime");
            return false;
        }
        results = check_datetime(datetime);
        if (results[0]) {
            console.log("date ok");
            $(input).css("color", "green");
        } else {
            console.log("date bad: " + results[1]);
            alert(results[1]);
            $(input).css("color", "red");
        }
        return false;
    }

    validate_filename = function (event) {
        console.log("validate_filename");
        input = $(event.target);
        filename = input.val();
        if (!filename.length) {
            console.log("empty filename");
            return false;
        }
        try {
            assert(/^[a-zA-z][a-zA-Z0-9_]*[.][A-Za-z0-9_]+$/.test(filename),
                "Invalid filename = " + filename + " must consist of a name and " + 
                "extension,  separated by a period, with no path.   The name " +
                "and extension must consist of letters, digits, and underscores only.");
            console.log("filename ok");
            $(input).css("color", "green");
        } catch (err) {
            console.log("filename bad: " + err);
            alert(err);
            $(input).css("color", "red");
        }
        return false;
    }

    console.log("ready.")
});

</script>

<h2>Browse <a href='{{browsed_file|download_url:"hst"}}'>{{browsed_file|grey}}</a>
</h2> 

{% if status == "OK" %}
    <h3 class="success">
{% else %}
    <h3 class="error">
{% endif %}
        {{status}}
    </h3>
    
{% if not uploaded %}
<h3>CRDS Database</h3>
        {% if fileblob %}        
            <table border="1">
                 <tr>
                    <td width="20%" align="left" class="label">Delivery Date</td>
                    <td>{{fileblob.delivery_date|seconds}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Status</td>
                    <td class="{{fileblob.status_class}}">{{fileblob.status}}</td>
                 </tr>

       {% if is_authenticated %}
                 <tr>
                    <td width="20%" align="left" class="label">Path</td>
                    <td>{{fileblob.pathname|exists_color}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Submitter</td>
                    <td>{{fileblob.deliverer_user}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Submitter Email</td>
                    <td>{{fileblob.deliverer_email}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Author/Modifier</td>
                    <td>{{fileblob.modifier_name}}</td>
                 </tr>
       {% endif %}

                 <tr>
                    <td width="20%" align="left" class="label">Blacklisted By</td>
                    <td>
                        {% if fileblob.blacklisted_by %}
                            {% for bl in fileblob.blacklisted_by %}
                                {{bl|browse}} ,&nbsp;
                            {% endfor %}
                        {% else %}
                            none
                        {% endif %}
                    </td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Description</td>
                    <td>{{fileblob.description}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Uploaded Name</td>
                    <td>{{fileblob.uploaded_as}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="label">Sha1sum</td>
                    {% if fileblob.sha1sum %}
                        {% if fileblob.checksum_ok %}
                           <td class="success">{{fileblob.sha1sum}}</td>
                        {% else %}
                           <td class="error">{{fileblob.sha1sum}}</td>
                        {% endif %}
                    {% else %}
                           <td class="orange">undefined</td>
                    {% endif %}
                 </tr>
            </table>
        {% else %}
            <p class="error">Error loading database record for 
                <span class="grey">{{browsed_file}}</span>
            </p>
        {% endif %}
{% else %}
    <h3>No Database (uploaded)</h3>
{% endif %}
    
<h3>File Actions</h3>
    <table border="1">
        <tr>
            <th width="15%" align="center">Date</th>
            <th width="10%" align="center">Action</th>
            <th width="10%" align="center">User</th>
            <th width="30%" align="center">Why</th>
            <th width="20%" align="center">Details</th>
        </tr>
        {% for action in related_actions %}
        <tr>
            <td align="center">{{action.date|minutes}}</td>
            <td align="center">{{action.action}}</td>
            <td align="center">{{action.user}}</td>
            <td align="center">{{action.why}}</td>
            <td align="center">{{action.details}}</td>
        </tr>
        {% endfor %}
    </table>

<h3>File Contents</h3>

    <div class='program' id="file_contents">
        {% if is_authenticated %}
            {% if "rmap" in browsed_file %}
                <button type='button' id="edit_rmap">Edit Rmap</button>
            {% endif %}
        {% endif %}
    
        <form action="/edit_rmap/" method="post" id="update_rmap_form">  
            
            <input type='hidden' name='browsed_file' value='{{browsed_file}}' />
            
            {{ file_contents|safe }}
        
        </form>
        
        <br/><br/>
    </div>

{% endblock contents %}
