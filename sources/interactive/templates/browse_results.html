{% extends "base.html" %}

{% load stdtags %}

{% block contents %}

<h2>
    Browse {{browsed_file|gray}}     

    {% if browsed_file|endswith:".pmap" %}
    &nbsp;&nbsp;
    <a href='/context_table/{{browsed_file}}'>
        <span style="font-size: 0.75em;">context table</span>
    </a>
    {% endif %}

    &nbsp;&nbsp;
    <span style="font-size: 0.75em;">
      {{browsed_file|download_link|safe}}
    </span>

    {% if is_superuser %}
    &nbsp;&nbsp;
    <a href='/admin/interactive/fileblob/{{fileblob.id}}'>
        <span style="font-size: 0.75em;">admin</span>
    </a>
    {% endif %}

    {% include "browse_results_diff_link.html" %}

</h2> 

{% accordion "Database" %}
        {% if fileblob %}        
            <table border="1">
                <tr>
                    <td width="20%" align="left" class="tdlabel">CRDS Name</td>
                    <td>{{fileblob.pathname|exists_color}}</td>
                </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Uploaded Name</td>
                    <td>{{fileblob.uploaded_as}}</td>
                 </tr>
                <tr>
                    <td width="20%" align="left" class="tdlabel">Sha1sum</td>
                    {% if fileblob.sha1sum %}
                        <td>{{fileblob.sha1sum}}</td>
                    {% else %}
                        <td class="orange">undefined</td>
                    {% endif %}
                </tr>
                <tr>
                    <td width="20%" align="left" class="tdlabel">Size (bytes)</td>
                    <td>{{fileblob.size}}</td>
                </tr>
                <tr>
                    <td width="20%" align="left" class="tdlabel">Status</td>
                    <td class="{{fileblob.status_class}}">{{fileblob.status}}</td>
                </tr>
                
                 {% if fileblob.blacklisted_by %}
                     <tr>
                        <td width="20%" align="left" class="tdlabel">Blacklisted By</td>
                        <td>
                            {% for bl in fileblob.blacklisted_by %}
                                <span class="red">{{bl}}</span> &nbsp;&nbsp;
                            {% endfor %}
                        </td>
                     </tr>
                 {% endif %}
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Reject Flag</td>
                    <td>{{fileblob.rejected}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Replaced By File Name</td>
                    <td>{{fileblob.replaced_by_filename}}</td>
                 </tr>
                
                {% if is_authenticated %}
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Submitter</td>
                    <td>{{fileblob.deliverer_user}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Submitter Email</td>
                    <td>{{fileblob.deliverer_email}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Creator Name</td>
                    <td>{{fileblob.creator_name}}</td>
                 </tr>
                {% endif %}

                <tr>
                    <td width="20%" align="left" class="tdlabel">Submit Description</td>
                    <td>{{fileblob.description}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Derived From</td>
                    <td>{{fileblob.derived_from}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Change Level</td>
                    <td>{{fileblob.change_level}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Delivery Date</td>
                    <td>{{fileblob.delivery_date_str}}</td>
                 </tr>
                 <tr>
                    <td width="20%" align="left" class="tdlabel">Activation Date</td>
                    <td>{{fileblob.activation_date_str}}</td>
                 </tr>
                 {% if fileblob.type == "reference" %}
                     <tr>
                        <td width="20%" align="left" class="tdlabel">History</td>
                        <td class="simple_white">
                          <pre class="simple_white">{{fileblob.history}}</pre>
                        </td>
                     </tr>
                     <tr>
                        <td width="20%" align="left" class="tdlabel">Descrip</td>
                        <td>{{fileblob.comment}}</td>
                     </tr>
                     <tr>
                        <td width="20%" align="left" class="tdlabel">Pedigree</td>
                        <td>{{fileblob.pedigree}}</td>
                     </tr>
                      <tr>
                        <td width="20%" align="left" class="tdlabel">Useafter Date</td>
                        <td>{{fileblob.useafter_date_str}}</td>
                     </tr>
                     <tr>
                        <td width="20%" align="left" class="tdlabel">Aperture</td>
                        <td>{{fileblob.aperture}}</td>
                     </tr>
                 {% endif %}
            </table>
        {% else %}
            <p class="error">Error loading database record for 
                <span class="gray">{{browsed_file}}</span>
            </p>
        {% endif %}
{% endaccordion %}

{% accordion "Contents" %}
    <div class="simple_white" id="file_contents">
      {{ file_contents|safe }}
      <br/>
    </div>
{% endaccordion %}

{% if certify_results %}
    {% accordion "Certify Results"  {{certify_results.0|color_status}} %}
    <div class='program' id="certify_results">
        <pre>
{{ certify_results.1|safe }}
        </pre>
    </div>
    {% endaccordion %}    
{% endif %}

{% accordion "Past Actions" %}
    <table border="1">
        <tr>
            <th width="15%" align="center">Date</th>
            <th width="10%" align="center">Action</th>
            <th width="10%" align="center">User</th>
            <th width="30%" align="center">Why</th>
            <th width="20%" align="center">Details</th>
        </tr>
        {% for action in related_actions %}
        <tr>
            <td align="center">{{action.date|minutes}}</td>
            <td align="center">{{action.action}}</td>
            <td align="center">{{action.user}}</td>
            <td align="center">{{action.why}}</td>
            <td align="center">{{action.details}}</td>
        </tr>
        {% endfor %}
    </table>
{% endaccordion %}

{% accordion "Used By Files" %}
    <div class="uses_tag" filename="{{browsed_file}}"></div>    
{% endaccordion %}

{% if match_paths %}
    {% accordion "Lookup Patterns" %}
    <table border="1">
        {% if match_paths %}
            {% for item in match_paths.0 %}
                <td><b>{{item.0|upper}}</b></td>
            {% endfor %}
            {% for match in match_paths %}
                <tr>
                {% for item in match %}
                    <td>{{item.1}}</td>
                {% endfor %}
                </tr>
            {% endfor %}
        {% else %}
            <tr><td><b>no matches</b></td></tr>
        {% endif %}
    </table>
    {% endaccordion %}
</div>
{% endif %}   

{% if tpn_text %}
    {% accordion "Reference Constraints (.tpn)" %}
<div id="tpn_text">
<pre class="program">
{{tpn_text}}
</pre>
</div>
    {% endaccordion %}
{% endif %}

{% if ld_tpn_text %}
    {% accordion "Rmap Constraints (_ld.tpn)" %}
<div id="ld_tpn_text">
<pre class="program">
{{ld_tpn_text}}
</pre>
</div>
    {% endaccordion %}
{% endif %}

<br/><br/>

{% endblock contents %}

{% block body_trailer %}
<script type="text/javascript">
$(function () {
    $("#contents").hide();
    $(".accordion").accordion({
        change: function( event, ui ) {
            console.log(event);
            var div = $(ui.newContent).children("div.uses_tag");
            if (!div) { 
               return; 
            };
            if (div.html()) {
                console.log("table already intialized")
                return;
            };
            var filename = div.attr("filename");
            var url = "/uses/" + filename;
            if (!filename) {
               console.log("no url,  skipping fetch.");
               return;
            };
            console.log("Fetching " + url);
            div.html($("<p class='green'>").html("Computing files using this one... (may take a long time)"));
            $.ajax({
                url : url,
                context: document.body
            }).done(function (json) {
                div.hide();
                var filelist = "";
                for (var i=0; i<json.length; i++) {
                       filelist += "<a href='/browse/" + json[i] + "' class='browse_a'>" + json[i] + "</a><span>,&nbsp;</span> ";
                };
                div.html("<p>" + filelist + "</p>");
                div.show();
            }).fail(function () {
                div.hide();
                div.html("Computation of used files failed.").css("color", "red");
                div.show();
            });
        },
    });
    $("#contents").show();
});
</script>

{% endblock body_trailer %}


