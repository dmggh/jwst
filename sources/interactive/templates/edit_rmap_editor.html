{% extends "base.html" %}

{% load stdtags %}

{% block head_additions %}

{% include "jsonrpc.html" %}

<script type="text/javascript">  

$ = jQuery;

$( function () {
    
    console.log("initing.")
    
    var add_count = 0;    
    var del_count = 0;
    
    var OBSERVATORY = "{{ observatory }}";
    
    // notify_err is used to output error status for input validation.
    // it assumes that `input` is encapsulated in a <p> element to which
    // an error message span can be appended.
    notify_err = function (input, msg) {
        // alert(msg);
        // $("div.error").html("<p>" + msg + "</p>");
        var p = input.parent();
        p.find("span.error").remove();
        if (msg) {
            console.log("ERROR: ", msg);
            p.append("<span class='error'>&nbsp;&nbsp;&nbsp;&nbsp;" + msg + "</span>");
            INVALID_ADDS[input.attr("name")] = msg;
            input.css("color", "red");
        } else {
            delete INVALID_ADDS[input.attr("name")];
            delete INVALID_ADDS[undefined];
            input.css("color", "green");
            $("input[type=submit]")
                .css("color","black")
                .parent().find("span.error").remove();
        }
        return false;
    }

    parse_useafter = function (p) {
        if (!(p.hasClass("useafter") || p.hasClass("dynamic"))) {
            return undefined;
        }
        var match_tuple = p.parent().children().html().split(":")[0];
        match_tuple = match_tuple.slice(match_tuple.indexOf("("), match_tuple.length);
        match_tuple = $.trim(match_tuple);
        if (p.hasClass("dynamic")) {
            var filename = p.find("input[name$=filename]").val();
            var date = p.find("input[name$=date]").val();
        } else {
            var filename = p.find("span.filename").text().slice(1,-1);
            var date = p.find("span.datetime").text().slice(1, -1);
        }
        console.log("match tuple: " + match_tuple + 
                    " useafter: " + date + 
                    " filename: " + filename);
        return {
            match_tuple: match_tuple,
            date: date,
            filename: filename,
        }
    }
    
    mk_input = function (type, name, value) {
        var hidden = '<input type="' + type + '" name="' +
                       name + '" value="' + value +'">'
        console.log(hidden)
        return hidden
    }
    
    // click: Called to insert a bundle of inputs after the button's paragraph to
    // handle adding an extra useafter line.   Schedules an addition.
    add_useafter = function (event, is_replacement) {
        console.log("add_useafter");
        
        var button = $(event.target);
        var parsing = parse_useafter(button.parent())
        var name_prefix = "add." + add_count++;
        
        var input_bundle;
        if (!is_replacement) {  // date is a text input, have delete
            input_bundle = "<p class='dynamic'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +
                mk_input("text", name_prefix + ".date", '') + " : " +
                mk_input("file", name_prefix + ".filename", '') + 
                mk_input("hidden", name_prefix + ".match_tuple", parsing.match_tuple) +
                "<button class='add' type='button'>+</button>" + 
                "<button class='del' type='button'>delete</button>" +
                "</p>";
           INVALID_ADDS[name_prefix + ".date"] = "empty";
           $("input[name$=date]", input_bundle).change(validate_useafter);
        } else {   // date is fixed for replacements, unvalidted. replacements have no delete.
            input_bundle = "<p class='dynamic'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +
                mk_input("hidden", name_prefix + ".date", parsing.date) + 
                mk_input("hidden", name_prefix + ".match_tuple", parsing.match_tuple) +
                "<span class='datetime'>'" + parsing.date + "'</span> : " + 
                mk_input("file", name_prefix + ".filename", '') + 
                "<button class='add' type='button'>+</button>" + 
                "</p>";
        }
        
        input_bundle = $(input_bundle);
                 
        $("button[class=add]", input_bundle).click(add_useafter);
        $("button[class=del]", input_bundle).click(del_useafter_dynamic);
        $("input[name$=filename]", input_bundle).change(validate_filename);
        	
       INVALID_ADDS[name_prefix + ".filename"] = "empty";
        	
        button.parent().after(input_bundle);
    }
    
    // click: Called to cross off a useafter in the original rmap and schedule deletion.
    del_useafter_static = function(event) {
        console.log("del_useafter");

        var button = $(event.target);
        button.parent().find("span")
            .css("text-decoration", "line-through")
            .css("color", "red");

        var parsing = parse_useafter(button.parent())
        var name_prefix = "delete." + del_count++;
        var p = button.parent();
        
        $("<div class='dynamic' style='display:none'>" + 
          mk_input("hidden", name_prefix + ".match_tuple", parsing.match_tuple) + 
          mk_input("hidden", name_prefix + ".date", parsing.date) +
          mk_input("hidden", name_prefix + ".filename", parsing.filename) +
          "</div>")
          .appendTo(p);

        button.remove();
        
        $("button[class=add]", p)
            .unbind("click")
            .html("unreplace")
            .click(unreplace_useafter);
    }
    
    // click:  Called to strike out a line and add a new one.
    replace_useafter = function (event) {
        // Add the inputs for the replacement line,  and + button.
        add_useafter(event, true);
        // Strike out the original line and add hidden inputs.
        del_useafter_static(event)
    }
        
    // click: Called to remove an added useafter line.
    del_useafter_dynamic = function(event) {
        if (!confirm("Delete this added useafter?")) {
            return true;
        }
        var button = $(event.target);
        console.log("del_useafter_dynamic", button);
        del_add_bundle(button.parent());
    }
    
    // internal: Called to remove an added line containing inputs and buttons.
    del_add_bundle = function(bundle) {
        console.log("del_add_bundle", $(bundle));
        var inputs = bundle.find("input[name^=add]");
        inputs.each( function () {
            var name = $(this).attr("name");
            console.log("deleting ", name);
            delete INVALID_ADDS[name];
        });
        bundle.remove();
    }
    
    // click: Called to reinstate a useafter line crossed-out of the original.
    undel_useafter = function(event) {
        console.log("undel_useafter");
        var button = $(event.target);
        var p = button.parent();
        p.find("span")
            .css("text-decoration", "none")
            .css("color", "grey");
        p.find("div").remove();     // the hidden input bundle
        p.find("button").remove();  // the +- appended to the useafter p
    }
    
    // click: Called to reinstate a replaced line,  marking unchanged, removing add.
    unreplace_useafter = function (event) {
        if (!confirm("Reinstate this useafter and delete added line?")) {
            return true;
        }
        var bundle = $(event.target).parent().next();
        del_add_bundle(bundle);
        undel_useafter(event);
    }

    // Use the form click handler to toggle +- buttons on useafter lines only.
    // This is a performance / transparency compromise since adding buttons 
    // and/or inputs to all lines of large rmaps is too slow.   Pass on events
    // which occur in the + inputs.
 
    $("form#update_rmap_form").click( function (event) {
        var target = $(event.target);
        console.log("update rmap form ", $(event), target);
        var p = target.parent();
        var div = p.parent();
        
        // Clicking on an input or button should not toggle the button.
        if (target[0].nodeName == "INPUT" || target[0].nodeName == "BUTTON") {
            if (!(target[0].nodeValue in {"+":1, "replace":1, "unreplace":1, "delete":1})) {
                console.log("exiting on input or button.");
                return true;
            }
            if (target.attr("type") == "submit") {
                return true;
            }
            console.log("update_rmap_form skipping input");
            return false;
        }
        
        // Skip over clicks which don't correspond to useafter lines.
        if (!p.length || p[0].nodeName != "P") {
            console.log("non-P parent");
            return true;
        }
        if (!div.length || div[0].nodeName != "DIV") {
            console.log("DIV not found");
            return true;
        }
        if (!div.hasClass("match")) {
            console.log("match not found");
            return true;
        }
        
        // toggle +- buttons on edit line
        if (p.find("button").length) {   
            $("button",p).remove()
        } else {
            $("<span>   </span>").appendTo(p);
            $("<button class='add' type='button'>+</button>")
                .click(add_useafter)
                .bind("keypress", add_useafter_keypress)
                .appendTo(p);
            if (!p.hasClass("match")) {  // no - button on UseAfter line
                $("<button class='del' type='button'>replace</button>")
                    .click(replace_useafter)
                    .appendTo(p);
            }
        }
    });
    
    add_useafter_keypress = function ( event ) {
        console.log("add_useafter_keypress");
    }
    
    assert = function (exp, message) {
        if (!exp) {
            throw message;
        }
    }

    assert_range = function (name, value, min, max) {
        assert( (value) >= min && (value <= max), 
                "Invalid " + name + " = " + value + 
                " must be in range " + min + " .. " + max + ".");
    }

    DATETIME_RE = /^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d$/;

    check_datetime = function (datetime) {
        try {
            assert(DATETIME_RE.test(datetime), 
                "datetime must match general format  yyyy-mm-dd hh:mm:ss");

            var parts = datetime.split(" ");
 
            var date = parts[0].split("-")
            var year = date[0];
            var month = date[1];
            var day = date[2];
            
            var hms = parts[1].split(":");
            var hours = hms[0];
            var minutes = hms[1];
            var seconds = hms[2];

            assert_range("year", year, "1990", "2050");
            assert_range("month", month, "01", "12");
            assert_range("day", day, "01", "31");
            
            assert_range("hours", hours, "00", "23");
            assert_range("minutes", minutes, "00", "59");
            assert_range("seconds", seconds, "00", "59");

            return ""
        } catch (err) {
            return err
        }
    }
    
    validate_useafter = function (event) {
        console.log("validate_useafter");
        var input = $(event.target);
        input.val($.trim(input.val()));
        var input_name = input.attr("name");
        var datetime = input.val();
        if (!datetime.length) {
            console.log("empty datetime");
            return false;   // allow empty date for now.
        }
        var err = check_datetime(datetime);
        if (err) {
            return fail_useafter(input, err);
        }
        var p = input.parent();
        var prev = p.prev();
        console.log(prev);
        var parsing = parse_useafter(prev);
        if (parsing) {
            console.log("prev_date", parsing.date);
            if (parsing.date >= datetime) {
                return notify_err(input, "New date must be > preceding date.");
            } 
        }
        var next = p.next();
        parsing = parse_useafter(next);
        if (parsing) {
            console.log("next_date", parsing.date);
            if (parsing.date <= datetime) {
                return notify_err(input, "New date must be < following date.");
            } 
        }
        return notify_err(input, "");   // ok
    }

    validate_filename = function (event) {
        var input = $(event.target);
        var filename = input.val();
        var input_name = input.attr("name");
        console.log("validate_filename ", input_name, " ", filename);
        if (!filename.length) {
            console.log("ignoring empty filename");
            return false;
        }
        try {
            assert(/^[a-zA-Z0-9_\/.]+$/.test(filename), "Invalid filename '" + filename + "'");
            return notify_err(input, ""); // ok
        } catch (err) {
            return notify_err(input, err);
        }
    }
    
/*    deferred = jsonrpc.file_exists(filename);
    deferred.addCallback( function (req) {
        console.log("validate_filename callback ", req.result);
        if (req.result) {
            console.log("validate_filename ok ", input_name);
            $(input).css("color", "green");
            delete INVALID_ADDS[input_name];
        } else {
            return handle_bad("CRDS can't find");
        }
    });
    deferred.addErrback( function (req) {
        console.log("validate_filename errback file existence check failed", req.result);
        $(input).css("color", "orange");
        delete INVALID_ADDS[input_name];   //  Let the server figure it out.
    });
*/
    
    
    $("#update_rmap_form").submit( function (event) {
        console.log("form submit", $(event.target));
        if (confirm("Submit edits to generate new rmap?")) {
            console.log("submit confirmed");
            if (validate_all_inputs()) {
                console.log("form validated.");
                $("form")[0].submit();
                return true;
            }
            console.log("form validation failed.");
            return false;
        }
        console.log("submit cancelled.");
        return false;
    });
    
    $("#submit_button").click( function (event) {
        console.log("submit button ", $(event.target));
        return true;
    });
    
    INVALID_ADDS = {}
    
    validate_all_inputs = function () {
        actions = $("p.dynamic, div.dynamic");
        console.log("validate all inputs", actions);
        var input = $("input[type=submit]");
        if (actions.length == 0) {
            return notify_err(input, "No edits have been recorded.");
        }
        // check for invalid or empty inputs.
        if (Object.keys(INVALID_ADDS).length) {
            return notify_err(input, "Some inputs are either empty or invalid (marked red).");
        }
        return true;
    }
    
    console.log("ready.")
});

</script>
{% endblock head_additions %}

{% block contents %}

<h2>Edit Rmap <a href='{{browsed_file|download_url:"hst"}}'>{{browsed_file|grey}}</a>
</h2> 

    <p class="grey">Click on a useafter date to edit the rmap at that location.</p>
    <br/>
    
    <div class='program' id="file_contents">
    
        <form action="/edit_rmap/" method="post" id="update_rmap_form" enctype="multipart/form-data">  
            
            <input type='hidden' name='browsed_file' value='{{browsed_file}}' />
     
            {{ file_contents|safe }}
            
            <br/>
            <p>
                <input type='submit' id="submit_button" value='Submit Rmap Update' />
            </p> 
        </form>
        
        <br/><br/>
    </div>

{% endblock contents %}
