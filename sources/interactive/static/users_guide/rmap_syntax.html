

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>About Mappings &mdash; CRDS Users Manual 1.0a documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0a',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="CRDS Users Manual 1.0a documentation" href="index.html" />
    <link rel="next" title="&lt;no title&gt;" href="command_line_tools.html" />
    <link rel="prev" title="Using the CRDS Web Site" href="web_site_use.html" />
<link rel="stylesheet" href="_static/style.css"  type="text/css">

  </head>
  <body>
<div id="header" class="related">
  <a href="/"><img ALT="Hubble Space Telescope" SRC="_static/HSTBlackTitle.jpg" style="border-style: none"></a>
    <h2>Calibration and Reference Data System (CRDS)</h2>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="about-mappings">
<h1>About Mappings<a class="headerlink" href="#about-mappings" title="Permalink to this headline">¶</a></h1>
<p>CRDS mappings are organized in a 3 tier hierarchy:  pipeline (.pmap),
instrument (.imap), and reference (.rmap).   Based on dataset parameters,
the pipeline context is used to select an instrument mapping,  the instrument
mapping is used to select a reference mapping,  and finally the reference
mapping is used to select a reference file.</p>
<p>CRDS mappings are written in a subset of Python and given the proper global
definitions can be parsed directly by the Python interpreter.   Nothing
precludes writing a parser for CRDS mappings in some other language.</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/file_relationships.png"><img alt="diagram of file relationships, .pmap -&gt; .imap -&gt; .rmap -&gt; .reference" src="_images/file_relationships.png" style="width: 595.5px; height: 446.5px;" /></a>
</div>
<div class="section" id="naming">
<h2>Naming<a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h2>
<p>The CRDS HST mapping prototypes which are generated from information scraped from
the CDBS web site are named with the forms:</p>
<div class="highlight-python"><pre>&lt;observatory&gt; .pmap                               .e.g. hst.pmap
&lt;observatory&gt; _ &lt;instrument&gt; .imap                .e.g. hst_acs.imap
&lt;observatory&gt; _ &lt;instrument&gt; _ &lt;filekind&gt; .rmap   .e.g. hst_acs_darkfile.rmap</pre>
</div>
<p>The names of subsequent derived mappings include a version number:</p>
<div class="highlight-python"><pre>&lt;observatory&gt; _ &lt;version&gt; .pmap                               .e.g. hst_00001.pmap
&lt;observatory&gt; _ &lt;instrument&gt; _ &lt;version&gt; .imap                .e.g. hst_acs_00047.imap
&lt;observatory&gt; _ &lt;instrument&gt; _ &lt;version&gt; _ &lt;filekind&gt; .rmap  .e.g. hst_acs_darkfile_00012.rmap</pre>
</div>
</div>
<div class="section" id="basic-structure">
<h2>Basic Structure<a class="headerlink" href="#basic-structure" title="Permalink to this headline">¶</a></h2>
<p>All mappings have the same basic structure consisting of a &#8220;header&#8221; section
followed by a &#8220;selector&#8221; section.   The header provides meta data describing
the mapping,  while the selector provides matching rules used to look up
the results of the mapping.   A critical field in the mapping header is the
&#8220;parkey&#8221; field which names the dataset header parameters which are used by
the selector to do its lookup.</p>
</div>
<div class="section" id="pipeline-mappings-pmap">
<h2>Pipeline Mappings (.pmap)<a class="headerlink" href="#pipeline-mappings-pmap" title="Permalink to this headline">¶</a></h2>
<p>A sample pipeline mapping for HST looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&#39;hst.pmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;derived_from&#39;</span> <span class="p">:</span> <span class="s">&#39;created by hand 12-23-2011&#39;</span><span class="p">,</span>
    <span class="s">&#39;mapping&#39;</span> <span class="p">:</span> <span class="s">&#39;PIPELINE&#39;</span><span class="p">,</span>
    <span class="s">&#39;observatory&#39;</span> <span class="p">:</span> <span class="s">&#39;HST&#39;</span><span class="p">,</span>
    <span class="s">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s">&#39;INSTRUME&#39;</span><span class="p">,),</span>
    <span class="s">&#39;description&#39;</span> <span class="p">:</span> <span class="s">&#39;Initially generated on 12-23-2011&#39;</span><span class="p">,</span>
    <span class="s">&#39;sha1sum&#39;</span> <span class="p">:</span> <span class="s">&#39;e2c6392fd2731df1e8d933bd990f3fd313a813db&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">selector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;ACS&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_acs.imap&#39;</span><span class="p">,</span>
    <span class="s">&#39;COS&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos.imap&#39;</span><span class="p">,</span>
    <span class="s">&#39;NICMOS&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_nicmos.imap&#39;</span><span class="p">,</span>
    <span class="s">&#39;STIS&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_stis.imap&#39;</span><span class="p">,</span>
    <span class="s">&#39;WFC3&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_wfc3.imap&#39;</span><span class="p">,</span>
    <span class="s">&#39;WFPC2&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_wfpc2.imap&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A pipeline mapping matches the dataset &#8220;INSTRUME&#8221; header keyword against its
selector to look up an instrument mapping file.</p>
</div>
<div class="section" id="instrument-mappings-imap">
<h2>Instrument Mappings (.imap)<a class="headerlink" href="#instrument-mappings-imap" title="Permalink to this headline">¶</a></h2>
<p>A sample instrument mapping for HST&#8217;s COS instrument looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;derived_from&#39;</span> <span class="p">:</span> <span class="s">&#39;scraped 2011-12-23 11:57:10&#39;</span><span class="p">,</span>
    <span class="s">&#39;description&#39;</span> <span class="p">:</span> <span class="s">&#39;Initially generated on 2011-12-23 11:57:10&#39;</span><span class="p">,</span>
    <span class="s">&#39;instrument&#39;</span> <span class="p">:</span> <span class="s">&#39;COS&#39;</span><span class="p">,</span>
    <span class="s">&#39;mapping&#39;</span> <span class="p">:</span> <span class="s">&#39;INSTRUMENT&#39;</span><span class="p">,</span>
    <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos.imap&#39;</span><span class="p">,</span>
    <span class="s">&#39;observatory&#39;</span> <span class="p">:</span> <span class="s">&#39;HST&#39;</span><span class="p">,</span>
    <span class="s">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s">&#39;REFTYPE&#39;</span><span class="p">,),</span>
    <span class="s">&#39;sha1sum&#39;</span> <span class="p">:</span> <span class="s">&#39;800fb1567cb5bed4031402c7396aeb86c5e1db61&#39;</span><span class="p">,</span>
    <span class="s">&#39;source_url&#39;</span> <span class="p">:</span> <span class="s">&#39;http://www.stsci.edu/hst/observatory/cdbs/SIfileInfo/COS/reftablequeryindex&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">selector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;badttab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_badttab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;bpixtab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_bpixtab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;brftab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_brftab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;brsttab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_brsttab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;deadtab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_deadtab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;disptab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_disptab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;flatfile&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_flatfile.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;fluxtab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_fluxtab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;geofile&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_geofile.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;lamptab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_lamptab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;phatab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_phatab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;spwcstab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_spwcstab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;tdstab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_tdstab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;wcptab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_wcptab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;xtractab&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_xtractab.rmap&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Instrument mappings match the desired reference file type against the
reference mapping which can be used to determine a best reference recommendation
for a particular dataset.  An instrument mapping lists all possible reference
types for all modes of the instrument,  some of which may not be appropriate
for a particular mode.   The selector key of an instrument mapping is the
value of a reference file header keyword &#8220;REFTYPE&#8221;,  and is the name of the
dataset header keyword which will record the best reference selection.</p>
</div>
<div class="section" id="reference-mappings-rmap">
<h2>Reference Mappings (.rmap)<a class="headerlink" href="#reference-mappings-rmap" title="Permalink to this headline">¶</a></h2>
<p>A sample reference mapping for HST COS DEADTAB looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;derived_from&#39;</span> <span class="p">:</span> <span class="s">&#39;scraped 2011-12-23 11:54:56&#39;</span><span class="p">,</span>
    <span class="s">&#39;description&#39;</span> <span class="p">:</span> <span class="s">&#39;Initially generated on 2011-12-23 11:54:56&#39;</span><span class="p">,</span>
    <span class="s">&#39;filekind&#39;</span> <span class="p">:</span> <span class="s">&#39;DEADTAB&#39;</span><span class="p">,</span>
    <span class="s">&#39;instrument&#39;</span> <span class="p">:</span> <span class="s">&#39;COS&#39;</span><span class="p">,</span>
    <span class="s">&#39;mapping&#39;</span> <span class="p">:</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span>
    <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&#39;hst_cos_deadtab.rmap&#39;</span><span class="p">,</span>
    <span class="s">&#39;observatory&#39;</span> <span class="p">:</span> <span class="s">&#39;HST&#39;</span><span class="p">,</span>
    <span class="s">&#39;parkey&#39;</span> <span class="p">:</span> <span class="p">((</span><span class="s">&#39;DETECTOR&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="s">&#39;TIME-OBS&#39;</span><span class="p">)),</span>
    <span class="s">&#39;sha1sum&#39;</span> <span class="p">:</span> <span class="s">&#39;e27984a6441d8aaa7cd28ead2267a6be4c3a153b&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">Match</span><span class="p">({</span>
    <span class="p">(</span><span class="s">&#39;FUV&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
        <span class="s">&#39;1996-10-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&#39;s7g1700gl_dead.fits&#39;</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s">&#39;NUV&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
        <span class="s">&#39;1996-10-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&#39;s7g1700ql_dead.fits&#39;</span><span class="p">,</span>
    <span class="p">}),</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Reference mapping selectors are constructed as a nested hierarchy of selection
operators which match against various dataset header keywords.</p>
<div class="section" id="parkeys">
<h3>Parkeys<a class="headerlink" href="#parkeys" title="Permalink to this headline">¶</a></h3>
<p>For reference mappings,  the header &#8220;parkey&#8221; field is a tuple of tuples.  Each
stage of the nested selector consumes the next tuple of header keys.  For the
example above,   the Match operator matches against the value of the dataset
keyword &#8220;DETECTOR&#8221;.   Based on that match, the selected UseAfter operator
matches against the dataset&#8217;s &#8220;DATE-OBS&#8221; and &#8220;TIME-OBS&#8221; keywords to lookup
the name of a reference file.</p>
</div>
</div>
<div class="section" id="selectors">
<h2>Selectors<a class="headerlink" href="#selectors" title="Permalink to this headline">¶</a></h2>
<p>All the CRDS selection operators are written to select either a filename <em>or</em>
a nested operator.   In the case of HST,  the Match operator locates a nested
UseAfter operator which in turn locates the reference file.</p>
<div class="section" id="match">
<h3>Match<a class="headerlink" href="#match" title="Permalink to this headline">¶</a></h3>
<p>Based on a dataset`s header values,  Match locates the match tuple which best
matches the dataset.   Conceptually this is a dictionary lookup.   In actuality,
CRDS processes each match parameter in succession,  at each step eliminating
match candidates that cannot possibly match.</p>
<div class="section" id="parameter-tuples-and-simple-matches">
<h4>Parameter Tuples and Simple Matches<a class="headerlink" href="#parameter-tuples-and-simple-matches" title="Permalink to this headline">¶</a></h4>
<p>The CRDS Match operator typically matches a dataset header against a tuple
which defines multiple parameter values whose names are specified in the rmap
header <cite>parkey</cite>:</p>
<div class="highlight-python"><pre>("UVIS", "F122LP")   :  'some_file_or_nested_selection'</pre>
</div>
<p>Alternately,  for simple use cases the Match operator can match against single
strings,  which is a simplified syntax for a 1-tuple:</p>
<div class="highlight-python"><pre>'UVIS'  :  'some_file_or_nested_selection'
('UVIS',) : 'this_is_the_equivalent_one_tuple'</pre>
</div>
</div>
<div class="section" id="single-parameter-values">
<h4>Single Parameter Values<a class="headerlink" href="#single-parameter-values" title="Permalink to this headline">¶</a></h4>
<p>Each value within the match tuples of a Match operator can be an expression in
its own right.   There are a number of special values associated with each
match expression:  Ors <a href="#id1"><span class="problematic" id="id2">|</span></a>, Wildcards <a href="#id3"><span class="problematic" id="id4">*</span></a>,  Regular Expressions (), Literals {},
Relationals, between, N/A, and Substitutions.</p>
</div>
<div class="section" id="or">
<h4>Or |<a class="headerlink" href="#or" title="Permalink to this headline">¶</a></h4>
<p>Many CRDS match expressions consist of a series of match patterns separated by
vertical bars.   The vertical bar is read as &#8220;or&#8221; and means that a match occurs
if either pattern matches that dataset header.   For example, the expression:</p>
<div class="highlight-python"><pre>("either_this|that","1|2|3")  : "some_file.fits"</pre>
</div>
<p>will match:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="s">&quot;either_this&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and also:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="s">&quot;that&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="wild-cards">
<h4>Wild Cards *<a class="headerlink" href="#wild-cards" title="Permalink to this headline">¶</a></h4>
<p>By default,  * is interpreted in CRDS as a glob pattern,  much like UNIX shell
file name matching.  * matches any sequence of characters.  The expression:</p>
<div class="highlight-python"><pre>("F*122",) : "some_file.fits"</pre>
</div>
<p>will match any value starting with &#8220;F&#8221; and ending with &#8220;122&#8221;.</p>
</div>
<div class="section" id="regular-expressions">
<h4>Regular Expressions<a class="headerlink" href="#regular-expressions" title="Permalink to this headline">¶</a></h4>
<p>CRDS can match on true regular expressions.   A true regular expression match is
triggered by bracketing the match in parentheses ():</p>
<div class="highlight-python"><pre>("(^F[^13]22$)",)  : "some_file.fits"</pre>
</div>
<p>The above corresponds to matching the regular expression &#8220;^F[^1234]22$&#8221; (note
that the bracketing parentheses within the string are removed.)   Regular
expression syntax is explained in the Python documentation for the re module.
The above expression will match values starting with &#8220;F&#8221;, followed by any
character which is not &#8220;1&#8221; or &#8220;3&#8221; followed by &#8220;22&#8221;.</p>
</div>
<div class="section" id="literal-expressions">
<h4>Literal Expressions<a class="headerlink" href="#literal-expressions" title="Permalink to this headline">¶</a></h4>
<p>A literal expression is bracketed with curly braces {} and is matched without
any interpretation whatsoever.   Hence,  special characters like * or | are
interpreted literally rather than as ors or wildcards.  The expression:</p>
<div class="highlight-python"><pre>("{F|*G}",) : "some_file.fits"</pre>
</div>
<p>matches the value &#8220;F|*G&#8221; as opposed to &#8220;F&#8221; or anything ending with &#8220;G&#8221;.</p>
</div>
<div class="section" id="relational-expressions">
<h4>Relational Expressions<a class="headerlink" href="#relational-expressions" title="Permalink to this headline">¶</a></h4>
<p>Relational expressions are bracketed by the pound character #.   Relational
expressions do numerical comparisons on the header value to determine a match.
Relational expressions have implicit variables and support the operators:</p>
<div class="highlight-python"><pre>&gt; &gt;= &lt; &lt;= == and or</pre>
</div>
<p>The expression:</p>
<div class="highlight-python"><pre>("# &gt;1 and &lt;37 #",)  : "some_file.fits"</pre>
</div>
<p>will match any number greater than 1 and less than 37.</p>
</div>
<div class="section" id="between">
<h4>Between<a class="headerlink" href="#between" title="Permalink to this headline">¶</a></h4>
<p>A special relational operator &#8220;between&#8221; is used to simply express a range
of numbers &gt;= to the lower bound and &lt; the upper bound,  similar to Python
slicing:</p>
<div class="highlight-python"><pre>("between 1  47",) : "some_file.fits"</pre>
</div>
<p>will match any number greater than or equal to 1 and less than 47.   This is
equivalent to:</p>
<div class="highlight-python"><pre>("# &gt;=1 and &lt;47 #",) : "some_file.fits"</pre>
</div>
<p>Note that &#8220;between&#8221; matches sensibly stack into a complete range.  The expressions:</p>
<div class="highlight-python"><pre>("between 1 47",) : "some_file.fits"
("between 47 90", ) : "another_file.fits"</pre>
</div>
<p>provide complete coverage for the range between 1 and 90.</p>
</div>
<div class="section" id="n-a">
<h4>N/A<a class="headerlink" href="#n-a" title="Permalink to this headline">¶</a></h4>
<p>Some rmaps have match tuple values of &#8220;N/A&#8221;,  or Not Applicable.
A value of N/A is matched as a special version of &#8220;*&#8221;, matching anything,  but
not affecting the &#8220;weight&#8221; of the match.</p>
<blockquote>
<div>(&#8216;HRC&#8217;, &#8216;N/A&#8217;) :  &#8220;some_file.fits&#8221;</div></blockquote>
<p>There are a couple uses for N/A parameters.    First,  sometimes a parameter is
irrelevant in the context of the other parameters.   So for an rmap which covers
multiple instrument modes,  a parameter may not apply to all modes. Second,
sometimes a parameter is relevant to custom lookup code,  but is not used by the
match directly.  In this second case,   the &#8220;N/A&#8221; parameter may be used by custom
header preconditioning code to assist in mutating the other parameter values
that <em>are</em> used in the match.</p>
</div>
<div class="section" id="substitution-parameters">
<h4>Substitution Parameters<a class="headerlink" href="#substitution-parameters" title="Permalink to this headline">¶</a></h4>
<p>Substituion parameters are short hand notation which eliminate the need to
duplicate rmap rules.  In order to support WFC3 biasfile conventions,  CRDS
rmaps permit the definition of meta-match-values which correspond to a set of
actual dataset header values. For instance,  when an rmap header contains a
&#8220;substitutions&#8221; field like this:</p>
<div class="highlight-python"><pre>'substitutions' : {
    'CCDAMP' : {
        'G280_AMPS' : ('ABCD', 'A', 'B', 'C', 'D', 'AC', 'AD', 'BC', 'BD'),
    },
},</pre>
</div>
<p>then a match tuple line like the following could be written:</p>
<div class="highlight-python"><pre>('UVIS', 'G280_AMPS', '1.5', '1.0', '1.0', 'G280-REF', 'T') : UseAfter({</pre>
</div>
<p>Here the value of G280_AMPS works like this:  first,   reference files listed
under that match tuple define CCDAMP=G280_AMPS.   Second, datasets which should
use those references define CCDAMP to a particular amplifier configuration,
.e.g.  ABCD.   Hence,  the reference file specifies a set of applicable
amplifier configurations,  while the dataset specifies a particular
configuration.   CRDS automatically expands substitutions into equivalent sets
of match rules.</p>
</div>
<div class="section" id="match-weighting">
<h4>Match Weighting<a class="headerlink" href="#match-weighting" title="Permalink to this headline">¶</a></h4>
<p>Because of the presence of special values like regular expressions, CRDS uses a
winnowing match algorithm which works on a parameter-by-parameter basis by
discarding match tuples which cannot possibly match. After examining all
parameters,   CRDS is left with a list of candidate matches.</p>
<p>For each literal, <a href="#id5"><span class="problematic" id="id6">*</span></a>, or regular expression parameter that matched,  CRDS
increases its sense of the goodness of the match by 1.   For each N/A that was
ignored, CRDS doesn&#8217;t change the weight of the match.   The highest ranked match
is the one CRDS chooses as best.   When more than one match tuple has the same
highest rank, we call this an &#8220;ambiguous&#8221; match.   Ambiguous matches will
either be merged,  or treated as errors/exceptions that cause the match to fail.
Talk about ambiguity.</p>
<p>For the initial HST rmaps, there are a number of match cases which overlap,
creating the potential for ambiguous matches by actual datasets.   For HST,  all
of the match cases refer to nested UseAfter selectors.  A working approach for
handling ambiguities here is to merge the two or more equal weighted UseAfter
lists into a single combined UseAfter which is then searched.</p>
<p>The ultimate goal of CRDS is to produce clear non-overlapping rules.  However,
since the initial rmaps are generated from historical mission data in CDBS,
there are eccentricities which need to be accomodated by merging or eventually
addressed by human beings who will simplify the rules by hand.</p>
</div>
</div>
<div class="section" id="useafter">
<h3>UseAfter<a class="headerlink" href="#useafter" title="Permalink to this headline">¶</a></h3>
<p>The UseAfter selector matches an ordered sequence of date time values to
corresponding reference filenames.   UseAfter finds the greatest date-time which
is less than or equal to ( &lt;= ) EXPSTART of a dataset.   Unlike
reference file and dataset timestamp values,  all CRDS rmaps represent times in
the single format shown in the rmap example below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">selector</span> <span class="o">=</span> <span class="n">Match</span><span class="p">({</span>
   <span class="p">(</span><span class="s">&#39;HRC&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
       <span class="s">&#39;1991-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&#39;j4d1435hj_a2d.fits&#39;</span><span class="p">,</span>
       <span class="s">&#39;1992-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&#39;kcb1734ij_a2d.fits&#39;</span><span class="p">,</span>
   <span class="p">}),</span>
   <span class="p">(</span><span class="s">&#39;WFC&#39;</span><span class="p">,)</span> <span class="p">:</span> <span class="n">UseAfter</span><span class="p">({</span>
       <span class="s">&#39;1991-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&#39;kcb1734hj_a2d.fits&#39;</span><span class="p">,</span>
       <span class="s">&#39;2008-01-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&#39;t3n1116mj_a2d.fits&#39;</span><span class="p">,</span>
   <span class="p">}),</span>
<span class="p">})</span>
</pre></div>
</div>
<p>In the above mapping,  when the detector is HRC,  if the dataset&#8217;s date/time
is before 1991-01-01,  there is no match.   If the date/time is between
1991-01-01 and 1992-01-01,  the reference file &#8216;j4d1435hj_a2d.fits&#8217; is matched.
If the dataset date/time is 1992-01-01 or after,  the recommended reference
file is &#8216;kcb1734ij_a2d.fits&#8217;</p>
</div>
<div class="section" id="selectversion">
<h3>SelectVersion<a class="headerlink" href="#selectversion" title="Permalink to this headline">¶</a></h3>
<p>The SelectVersion() rmap operator uses a software version and various relations
to make a selection:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">selector</span> <span class="o">=</span> <span class="n">SelectVersion</span><span class="p">({</span>
   <span class="s">&#39;&lt;3.1&#39;</span><span class="p">:</span>    <span class="s">&#39;cref_flatfield_65.fits&#39;</span><span class="p">,</span>
   <span class="s">&#39;&lt;5&#39;</span><span class="p">:</span>      <span class="s">&#39;cref_flatfield_73.fits&#39;</span><span class="p">,</span>
   <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="s">&#39;cref_flatfield_123.fits&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>While similar to relational expressions in Match(),   SelectVersion() is
dedicated, simpler,  and more self-documenting.  With the exception of default,
versions are examined in sorted order.</p>
</div>
<div class="section" id="closesttime">
<h3>ClosestTime<a class="headerlink" href="#closesttime" title="Permalink to this headline">¶</a></h3>
<p>The ClosestTime() rmap operator does a lookup on a series of times and selects
the closest time which either precedes or follows the given parameter value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">selector</span> <span class="o">=</span> <span class="n">ClosestTime</span><span class="p">({</span>
     <span class="s">&#39;2017-04-24 00:00:00&#39;</span><span class="p">:</span>  <span class="s">&quot;cref_flatfield_123.fits&quot;</span><span class="p">,</span>
     <span class="s">&#39;2018-02-01 00:00:00&#39;</span> <span class="p">:</span> <span class="s">&quot;cref_flatfield_222.fits&quot;</span><span class="p">,</span>
     <span class="s">&#39;2019-04-15 00:00:00&#39;</span><span class="p">:</span>  <span class="s">&quot;cref_flatfield_123.fits&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>So a parameter of &#8216;2017-04-25 00:00:00&#8217; would select &#8216;cref_flatfield_123.fits&#8217;.</p>
</div>
<div class="section" id="geometricallynearest">
<h3>GeometricallyNearest<a class="headerlink" href="#geometricallynearest" title="Permalink to this headline">¶</a></h3>
<p>The GeometricallyNearest() selector applies a distance relation between a
numerical parameter and the match values.   The match value which is closest to
the supplied parameter is chosen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">selector</span> <span class="o">=</span> <span class="n">GeomtricallyNearest</span><span class="p">({</span>
    <span class="mf">1.2</span> <span class="p">:</span> <span class="s">&quot;cref_flatfield_120.fits&quot;</span><span class="p">,</span>
    <span class="mf">1.5</span> <span class="p">:</span> <span class="s">&quot;cref_flatfield_124.fits&quot;</span><span class="p">,</span>
    <span class="mf">5.0</span> <span class="p">:</span> <span class="s">&quot;cref_flatfield_137.fits&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>In this case,  a value of 1.3 would match &#8216;cref_flatfield_120.fits&#8217;.</p>
</div>
<div class="section" id="bracket">
<h3>Bracket<a class="headerlink" href="#bracket" title="Permalink to this headline">¶</a></h3>
<p>The Bracket() selector is unusual because it returns the pair of selections which
enclose the supplied parameter value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">selector</span> <span class="o">=</span> <span class="n">Bracket</span><span class="p">({</span>
    <span class="mf">1.2</span><span class="p">:</span> <span class="s">&quot;cref_flatfield_120.fits&quot;</span><span class="p">,</span>
    <span class="mf">1.5</span><span class="p">:</span> <span class="s">&quot;cref_flatfield_124.fits&quot;</span><span class="p">,</span>
    <span class="mf">5.0</span><span class="p">:</span> <span class="s">&quot;cref_flatfield_137.fits&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Here,  a parameter value of 1.3 returns the value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="s">&#39;cref_flatfield_120.fits&#39;</span><span class="p">,</span> <span class="s">&#39;cref_flatfield_124.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
   <a href="index.html"><h2>Top</h2></a>
   <br/>
   
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">About Mappings</a><ul>
<li><a class="reference internal" href="#naming">Naming</a></li>
<li><a class="reference internal" href="#basic-structure">Basic Structure</a></li>
<li><a class="reference internal" href="#pipeline-mappings-pmap">Pipeline Mappings (.pmap)</a></li>
<li><a class="reference internal" href="#instrument-mappings-imap">Instrument Mappings (.imap)</a></li>
<li><a class="reference internal" href="#reference-mappings-rmap">Reference Mappings (.rmap)</a><ul>
<li><a class="reference internal" href="#parkeys">Parkeys</a></li>
</ul>
</li>
<li><a class="reference internal" href="#selectors">Selectors</a><ul>
<li><a class="reference internal" href="#match">Match</a><ul>
<li><a class="reference internal" href="#parameter-tuples-and-simple-matches">Parameter Tuples and Simple Matches</a></li>
<li><a class="reference internal" href="#single-parameter-values">Single Parameter Values</a></li>
<li><a class="reference internal" href="#or">Or |</a></li>
<li><a class="reference internal" href="#wild-cards">Wild Cards *</a></li>
<li><a class="reference internal" href="#regular-expressions">Regular Expressions</a></li>
<li><a class="reference internal" href="#literal-expressions">Literal Expressions</a></li>
<li><a class="reference internal" href="#relational-expressions">Relational Expressions</a></li>
<li><a class="reference internal" href="#between">Between</a></li>
<li><a class="reference internal" href="#n-a">N/A</a></li>
<li><a class="reference internal" href="#substitution-parameters">Substitution Parameters</a></li>
<li><a class="reference internal" href="#match-weighting">Match Weighting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#useafter">UseAfter</a></li>
<li><a class="reference internal" href="#selectversion">SelectVersion</a></li>
<li><a class="reference internal" href="#closesttime">ClosestTime</a></li>
<li><a class="reference internal" href="#geometricallynearest">GeometricallyNearest</a></li>
<li><a class="reference internal" href="#bracket">Bracket</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="web_site_use.html"
                        title="previous chapter">Using the CRDS Web Site</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="command_line_tools.html"
                        title="next chapter">&lt;no title&gt;</a></p>

   
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
   <br>
   <a href="/"><h2>Return to CRDS</h2></a>

        </div>
      </div>
      <div class="clearer"></div>
    </div>

<div class="footer" >
  <p align="left">
    If you have any questions regarding CRDS, please contact the
    STScI Help Desk <a HREF="mailto:help@stsci.edu">(help@stsci.edu)</a>.
  </p>
  
  <p align="left"> <a HREF="http://www.stsci.edu/institute/Copyright">Copyright Notice</a> </p>
  
  <p align="left"> <img BORDER="0" ALT="STScI" SRC="_static/HSTBanner.gif"/> </p>
</div>

  </body>
</html>